<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Message Details | SMS Portal</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background-color: #f8f9fa; }
    .sidebar a.active { background-color: #3b82f6 !important; }
    .header { background-color: white; padding:15px 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .card { border:none; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
    pre { background-color: #f1f3f9; padding: 1rem; border-radius: 8px; }
    .table th, .table td { vertical-align: middle; font-size: 0.9rem; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar dynamically loaded -->
      <div class="col-md-2 p-0" id="sidebarContainer"></div>

      <!-- Main content -->
      <div class="col-md-10">
        <div class="header d-flex justify-content-between align-items-center">
          <h4>Message Details</h4>
          <div><strong>User:</strong> admin1</div>
        </div>

        <div class="container mt-4">
          <div class="card p-4 mb-4">
            <h5 class="mb-3" id="msgTitle">Message Overview</h5>

            <!-- Message Info -->
            <div class="row mb-3">
              <div class="col-md-6">
                <p><strong>Sent By:</strong> <span id="msgSender"></span></p>
                <p><strong>Group(s):</strong> <span id="msgGroups"></span></p>
                <p><strong>Message Type:</strong> <span id="msgType"></span></p>
              </div>
              <div class="col-md-6">
                <p><strong>Date & Time:</strong> <span id="msgDate"></span></p>
                <p><strong>Total Recipients:</strong> <span id="msgCount"></span></p>
                <p><strong>Status:</strong> <span class="badge bg-success" id="msgStatus"></span></p>
              </div>
            </div>

            <!-- Template Preview -->
            <div class="mb-3">
              <h6>Message Template:</h6>
              <pre id="msgTemplate"></pre>
            </div>

            <!-- Variables Used -->
            <div class="mb-4">
              <h6>Variables Used:</h6>
              <ul id="msgVariables"></ul>
            </div>

            <!-- Recipients Table -->
            <div class="card mt-4">
              <div class="card-header bg-white fw-bold">Recipient Preview</div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>Name</th>
                        <th>Number</th>
                        <th>Message</th>
                      </tr>
                    </thead>
                    <tbody id="recipientTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="text-end mt-4">
              <button class="btn btn-outline-secondary me-2" onclick="window.history.back()">â¬… Back</button>
              <button class="btn btn-primary" onclick="resendMessage()">Resend Message</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../../static/js/common/common.js"></script>

  <script>
    // Dummy message dataset (you can fetch this from backend)
    const messages = [
      {
        id: 1,
        title: "Attendance Alert - Class 10A",
        sent_by: "Teacher: Mr. Ali",
        groups: ["Class 10A"],
        type: "student",
        datetime: "2025-10-16 09:45 AM",
        recipients: 3,
        status: "Delivered",
        message: "Dear parent, your child {student_name} was absent on {date}.",
        variables: { date: "15-10-2025" },
        recipients_list: [
          { name: "Ayesha Khan", number: "9876543210", personalized: "Dear parent, your child Ayesha Khan was absent on 15-10-2025." },
          { name: "Rohan Patel", number: "9123456789", personalized: "Dear parent, your child Rohan Patel was absent on 15-10-2025." },
          { name: "Sara Ahmed", number: "9988776655", personalized: "Dear parent, your child Sara Ahmed was absent on 15-10-2025." }
        ]
      },
      {
        id: 2,
        title: "Teacher Meeting Notice",
        sent_by: "Admin: Principal",
        groups: ["Teachers"],
        type: "teacher",
        datetime: "2025-10-15 02:30 PM",
        recipients: 2,
        status: "Delivered",
        message: "Dear {teacher_name}, please attend the meeting on {date} regarding {event}.",
        variables: { date: "18-10-2025", event: "Annual Event" },
        recipients_list: [
          { name: "Mr. Sharma", number: "9988223344", personalized: "Dear Mr. Sharma, please attend the meeting on 18-10-2025 regarding Annual Event." },
          { name: "Ms. Iqbal", number: "9776655443", personalized: "Dear Ms. Iqbal, please attend the meeting on 18-10-2025 regarding Annual Event." }
        ]
      }
    ];

    // Get message ID from query param (e.g. ?id=1)
    const urlParams = new URLSearchParams(window.location.search);
    const messageId = parseInt(urlParams.get("id")) || 1;
    const message = messages.find(m => m.id === messageId);

    function loadMessageDetails() {
      if (!message) {
        document.querySelector(".container").innerHTML = "<h5 class='text-danger'>Message not found!</h5>";
        return;
      }

      document.getElementById("msgTitle").textContent = message.title;
      document.getElementById("msgSender").textContent = message.sent_by;
      document.getElementById("msgGroups").textContent = message.groups.join(", ");
      document.getElementById("msgType").textContent = message.type.toUpperCase();
      document.getElementById("msgDate").textContent = message.datetime;
      document.getElementById("msgCount").textContent = message.recipients;
      document.getElementById("msgStatus").textContent = message.status;
      document.getElementById("msgTemplate").textContent = message.message;

      // Variables
      const varList = document.getElementById("msgVariables");
      varList.innerHTML = "";
      Object.entries(message.variables).forEach(([key, value]) => {
        varList.innerHTML += `<li><b>${key}</b>: ${value}</li>`;
      });

      // Recipients
      const tableBody = document.getElementById("recipientTableBody");
      tableBody.innerHTML = "";
      message.recipients_list.forEach(r => {
        tableBody.innerHTML += `
          <tr>
            <td>${r.name}</td>
            <td>${r.number}</td>
            <td>${r.personalized}</td>
          </tr>`;
      });
    }

    function resendMessage() {
      alert(`ðŸ“¨ Resending "${message.title}" to ${message.recipients} recipients...`);
      // Future: connect with MySMSMantra API resend endpoint
    }

    loadMessageDetails();
  </script>
</body>
</html>

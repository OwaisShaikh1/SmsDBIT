{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SMS Portal â€” Reports</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; min-height: 100vh; }
    .sidebar a.active { background-color: #3b82f6 !important; }
    .header { background-color: white; padding: 15px 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  </style>
</head>
<body>
  {% csrf_token %}
  <script>
    window.API_BASE = '{{ API_BASE }}';
  </script>

  <div class="container-fluid">
    <div class="row">
      <div class="col-md-2 p-0" id="sidebarContainer">
        {% include 'includes/sidebar.html' %}
      </div>

      <div class="col-md-10">
        <div class="header d-flex justify-content-between align-items-center">
          <div>
            <h4 class="mb-0">Reports</h4>
            <div style="font-size: .85rem; color: #6b7280;">SMS delivery reports and analytics</div>
          </div>
          <div class="text-end">
            <div style="font-size: .85rem; color: #6b7280;">Signed in as</div>
            <div><strong>{{ user.email }}</strong></div>
          </div>
        </div>

        <div class="container mt-4">
          <!-- Stats Cards -->
          <div class="row g-3 mb-4">
            <div class="col-md-3">
              <div class="card text-center p-3">
                <h6>Messages Sent</h6>
                <h3 class="text-primary" id="totalSent">0</h3>
                <small class="text-success">+12% from last month</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center p-3">
                <h6>Delivery Rate</h6>
                <h3 class="text-success" id="deliveryRate">0%</h3>
                <small class="text-success">+2.5% from last month</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center p-3">
                <h6>Failed Messages</h6>
                <h3 class="text-danger" id="failedCount">0</h3>
                <small class="text-danger">-5% from last month</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center p-3">
                <h6>Active Users</h6>
                <h3 class="text-info" id="activeUsers">0</h3>
                <small class="text-success">+8% from last month</small>
              </div>
            </div>
          </div>

          <!-- Report Filters -->
          <div class="card mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0">Report Filters</h5>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">Report Type</label>
                  <select class="form-select" id="reportType">
                    <option value="delivery">Delivery Report</option>
                    <option value="usage">Usage Report</option>
                    <option value="user_activity">User Activity</option>
                    <option value="financial">Financial Report</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Date Range</label>
                  <select class="form-select" id="dateRange">
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="week">Last 7 days</option>
                    <option value="month">Last 30 days</option>
                    <option value="custom">Custom Range</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Start Date</label>
                  <input type="date" class="form-control" id="startDate" disabled>
                </div>
                <div class="col-md-2">
                  <label class="form-label">End Date</label>
                  <input type="date" class="form-control" id="endDate" disabled>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                  <button class="btn btn-primary w-100" onclick="generateReport()">Generate Report</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts -->
          <div class="row g-3 mb-4">
            <div class="col-md-8">
              <div class="card">
                <div class="card-header bg-white">
                  <h5 class="mb-0">Message Delivery Trends</h5>
                </div>
                <div class="card-body">
                  <canvas id="deliveryChart" style="height: 300px;"></canvas>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-header bg-white">
                  <h5 class="mb-0">Message Categories</h5>
                </div>
                <div class="card-body">
                  <canvas id="categoryChart" style="height: 300px;"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Detailed Report Table -->
          <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Detailed Report</h5>
              <div>
                <button class="btn btn-outline-primary btn-sm" onclick="exportReport('csv')">Export CSV</button>
                <button class="btn btn-outline-secondary btn-sm" onclick="exportReport('pdf')">Export PDF</button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped" id="reportTable">
                  <thead>
                    <tr id="tableHeaders">
                      <!-- Headers will be populated based on report type -->
                    </tr>
                  </thead>
                  <tbody id="reportData">
                    <!-- Data will be populated here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    let deliveryChart, categoryChart;
    let reportData = {};

    // Initialize dashboard
    async function initializeDashboard() {
      await loadReportData();
      updateStats();
      initializeCharts();
      generateReport(); // Load default report
    }

    async function loadReportData() {
      try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const response = await fetch('/api/reports/dashboard/', {
          headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
          }
        });
        if (response.ok) {
          reportData = await response.json();
        }
      } catch (error) {
        console.error('Error loading report data:', error);
        // Mock data for demo
        reportData = {
          stats: {
            total_sent: 15847,
            delivery_rate: 94.2,
            failed_count: 920,
            active_users: 256
          },
          delivery_trends: [
            { date: '2025-01-10', sent: 1250, delivered: 1180, failed: 70 },
            { date: '2025-01-11', sent: 1340, delivered: 1265, failed: 75 },
            { date: '2025-01-12', sent: 1180, delivered: 1115, failed: 65 },
            { date: '2025-01-13', sent: 1420, delivered: 1338, failed: 82 },
            { date: '2025-01-14', sent: 1560, delivered: 1470, failed: 90 },
            { date: '2025-01-15', sent: 1680, delivered: 1585, failed: 95 }
          ],
          categories: [
            { name: 'Academic', count: 6500, percentage: 41.0 },
            { name: 'Administrative', count: 4200, percentage: 26.5 },
            { name: 'Events', count: 3100, percentage: 19.6 },
            { name: 'Emergency', count: 2047, percentage: 12.9 }
          ]
        };
      }
    }

    function updateStats() {
      document.getElementById('totalSent').textContent = reportData.stats.total_sent.toLocaleString();
      document.getElementById('deliveryRate').textContent = reportData.stats.delivery_rate + '%';
      document.getElementById('failedCount').textContent = reportData.stats.failed_count.toLocaleString();
      document.getElementById('activeUsers').textContent = reportData.stats.active_users.toLocaleString();
    }

    function initializeCharts() {
      // Delivery Trends Chart
      const deliveryCtx = document.getElementById('deliveryChart').getContext('2d');
      deliveryChart = new Chart(deliveryCtx, {
        type: 'line',
        data: {
          labels: reportData.delivery_trends.map(d => new Date(d.date).toLocaleDateString()),
          datasets: [
            {
              label: 'Sent',
              data: reportData.delivery_trends.map(d => d.sent),
              borderColor: 'rgb(59, 130, 246)',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4
            },
            {
              label: 'Delivered',
              data: reportData.delivery_trends.map(d => d.delivered),
              borderColor: 'rgb(16, 185, 129)',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.4
            },
            {
              label: 'Failed',
              data: reportData.delivery_trends.map(d => d.failed),
              borderColor: 'rgb(239, 68, 68)',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // Category Chart
      const categoryCtx = document.getElementById('categoryChart').getContext('2d');
      categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
          labels: reportData.categories.map(c => c.name),
          datasets: [{
            data: reportData.categories.map(c => c.count),
            backgroundColor: [
              'rgb(59, 130, 246)',
              'rgb(16, 185, 129)',
              'rgb(245, 158, 11)',
              'rgb(239, 68, 68)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    async function generateReport() {
      const reportType = document.getElementById('reportType').value;
      const dateRange = document.getElementById('dateRange').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      try {
        const params = new URLSearchParams({
          type: reportType,
          range: dateRange,
          start: startDate,
          end: endDate
        });
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const response = await fetch(`/api/reports/generate/?${params}`, {
          headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
          }
        });
        let data;
        
        if (response.ok) {
          data = await response.json();
        } else {
          // Mock data based on report type
          data = generateMockReportData(reportType);
        }
        
        renderReportTable(data, reportType);
      } catch (error) {
        console.error('Error generating report:', error);
        const mockData = generateMockReportData(reportType);
        renderReportTable(mockData, reportType);
      }
    }

    function generateMockReportData(reportType) {
      switch (reportType) {
        case 'delivery':
          return {
            headers: ['Date', 'Messages Sent', 'Delivered', 'Failed', 'Delivery Rate'],
            data: reportData.delivery_trends.map(d => [
              new Date(d.date).toLocaleDateString(),
              d.sent,
              d.delivered,
              d.failed,
              ((d.delivered / d.sent) * 100).toFixed(1) + '%'
            ])
          };
        
        case 'usage':
          return {
            headers: ['User', 'Role', 'Messages Sent', 'Last Activity', 'Status'],
            data: [
              ['admin@test.com', 'Admin', 2547, '2025-01-15 14:30', 'Active'],
              ['teacher1@school.com', 'Teacher', 1823, '2025-01-15 12:15', 'Active'],
              ['teacher2@school.com', 'Teacher', 1456, '2025-01-14 16:45', 'Active'],
              ['principal@school.com', 'Admin', 892, '2025-01-15 09:20', 'Active'],
              ['coordinator@school.com', 'Staff', 634, '2025-01-13 11:30', 'Inactive']
            ]
          };
        
        case 'user_activity':
          return {
            headers: ['Date', 'Logins', 'Messages Sent', 'Failed Attempts', 'Peak Hour'],
            data: [
              ['2025-01-15', 45, 1680, 3, '14:00-15:00'],
              ['2025-01-14', 42, 1560, 2, '10:00-11:00'],
              ['2025-01-13', 38, 1420, 5, '15:00-16:00'],
              ['2025-01-12', 35, 1180, 1, '11:00-12:00'],
              ['2025-01-11', 40, 1340, 4, '13:00-14:00']
            ]
          };
        
        case 'financial':
          return {
            headers: ['Date', 'Messages', 'Cost per SMS', 'Total Cost', 'Budget Used'],
            data: [
              ['2025-01-15', 1680, 'â‚¹0.15', 'â‚¹252.00', '12.6%'],
              ['2025-01-14', 1560, 'â‚¹0.15', 'â‚¹234.00', '11.7%'],
              ['2025-01-13', 1420, 'â‚¹0.15', 'â‚¹213.00', '10.7%'],
              ['2025-01-12', 1180, 'â‚¹0.15', 'â‚¹177.00', '8.9%'],
              ['2025-01-11', 1340, 'â‚¹0.15', 'â‚¹201.00', '10.1%']
            ]
          };
        
        default:
          return { headers: [], data: [] };
      }
    }

    function renderReportTable(data, reportType) {
      const headersRow = document.getElementById('tableHeaders');
      const dataBody = document.getElementById('reportData');
      
      // Clear existing content
      headersRow.innerHTML = '';
      dataBody.innerHTML = '';
      
      // Render headers
      data.headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headersRow.appendChild(th);
      });
      
      // Render data
      data.data.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach(cell => {
          const td = document.createElement('td');
          td.textContent = cell;
          tr.appendChild(td);
        });
        dataBody.appendChild(tr);
      });
    }

    function exportReport(format) {
      const reportType = document.getElementById('reportType').value;
      const table = document.getElementById('reportTable');
      
      if (format === 'csv') {
        let csv = '';
        
        // Get headers
        const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
        csv += headers.join(',') + '\n';
        
        // Get data
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        rows.forEach(row => {
          const cells = Array.from(row.querySelectorAll('td')).map(td => `"${td.textContent}"`);
          csv += cells.join(',') + '\n';
        });
        
        // Download
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', `${reportType}_report_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        alert('CSV report exported successfully!');
      } else if (format === 'pdf') {
        alert('PDF export functionality will be implemented with a PDF library like jsPDF');
      }
    }

    // Event listeners
    document.getElementById('dateRange').addEventListener('change', function() {
      const customFields = ['startDate', 'endDate'];
      const isCustom = this.value === 'custom';
      
      customFields.forEach(field => {
        const element = document.getElementById(field);
        element.disabled = !isCustom;
        if (isCustom && !element.value) {
          const date = new Date();
          if (field === 'endDate') {
            element.value = date.toISOString().split('T')[0];
          } else {
            date.setDate(date.getDate() - 7);
            element.value = date.toISOString().split('T')[0];
          }
        }
      });
    });

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initializeDashboard);
  </script>
</body>
</html>
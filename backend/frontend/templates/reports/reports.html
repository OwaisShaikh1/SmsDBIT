{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SMS Portal — Reports</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; min-height: 100vh; }
    .sidebar a.active { background-color: #3b82f6 !important; }
    .header { background-color: white; padding: 15px 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  </style>
</head>
<body>
  {% csrf_token %}
  <script>
    window.API_BASE = '{{ API_BASE }}';
  </script>

  <div class="container-fluid">
    <div class="row">
      <div class="col-md-2 p-0" id="sidebarContainer">
        <noscript>{% include 'includes/sidebar.html' with role=request.user.role %}</noscript>
      </div>

      <div class="col-md-10">
        <div class="header d-flex justify-content-between align-items-center">
          <div>
            <h4 class="mb-0">Reports</h4>
            <div style="font-size: .85rem; color: #6b7280;">SMS delivery reports and analytics</div>
          </div>
          <div class="text-end">
            <div style="font-size: .85rem; color: #6b7280;">Signed in as</div>
            <div><strong>{{ user.email }}</strong></div>
          </div>
        </div>

        <div class="container mt-4">
          <!-- Stats Cards -->
          <div class="row g-3 mb-4">
            <div class="col-md-3">
              <div class="card text-center p-3">
                <h6>Messages Sent</h6>
                <h3 class="text-primary" id="totalSent">0</h3>
                <small class="text-success">+12% from last month</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center p-3">
                <h6>Delivery Rate</h6>
                <h3 class="text-success" id="deliveryRate">0%</h3>
                <small class="text-success">+2.5% from last month</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center p-3">
                <h6>Failed Messages</h6>
                <h3 class="text-danger" id="failedCount">0</h3>
                <small class="text-danger">-5% from last month</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center p-3">
                <h6>Active Users</h6>
                <h3 class="text-info" id="activeUsers">0</h3>
                <small class="text-success">+8% from last month</small>
              </div>
            </div>
          </div>

          <!-- Report Filters -->
          <div class="card mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0">Report Filters</h5>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">Report Type</label>
                  <select class="form-select" id="reportType">
                    <option value="delivery">Delivery Report</option>
                    <option value="usage">Usage Report</option>
                    <option value="user_activity">User Activity</option>
                    <option value="financial">Financial Report</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Date Range</label>
                  <select class="form-select" id="dateRange">
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="week">Last 7 days</option>
                    <option value="month">Last 30 days</option>
                    <option value="custom">Custom Range</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Start Date</label>
                  <input type="date" class="form-control" id="startDate" disabled>
                </div>
                <div class="col-md-2">
                  <label class="form-label">End Date</label>
                  <input type="date" class="form-control" id="endDate" disabled>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                  <button class="btn btn-primary w-100" onclick="generateReport()">Generate Report</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts -->
          <div class="row g-3 mb-4">
            <div class="col-md-8">
              <div class="card">
                <div class="card-header bg-white">
                  <h5 class="mb-0">Message Delivery Trends</h5>
                </div>
                <div class="card-body">
                  <canvas id="deliveryChart" style="height: 300px;"></canvas>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-header bg-white">
                  <h5 class="mb-0">Message Categories</h5>
                </div>
                <div class="card-body">
                  <canvas id="categoryChart" style="height: 300px;"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Detailed Report Table -->
          <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Detailed Report</h5>
              <div>
                <button class="btn btn-outline-primary btn-sm" onclick="exportReport('csv')">Export CSV</button>
                <button class="btn btn-outline-secondary btn-sm" onclick="exportReport('pdf')">Export PDF</button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped" id="reportTable">
                  <thead>
                    <tr id="tableHeaders">
                      <!-- Headers will be populated based on report type -->
                    </tr>
                  </thead>
                  <tbody id="reportData">
                    <!-- Data will be populated here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  
  <script>
    let deliveryChart, categoryChart;
    let reportData = {};

    // Initialize with backend data
    reportData = {
      stats: {{ initial_stats|safe }},
      delivery_trends: {{ delivery_trends|safe }},
      categories: {{ categories|safe }}
    };

    // Initialize dashboard
    async function initializeDashboard() {
      await loadReportData();
      updateStats();
      initializeCharts();
      generateReport(); // Load default report
    }

    async function loadReportData() {
      try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const response = await fetch('/api/reports/dashboard/', {
          headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
          }
        });
        if (response.ok) {
          const freshData = await response.json();
          // Update with fresh data from API
          reportData = freshData;
          updateStats();
          updateCharts();
        }
      } catch (error) {
        console.error('Error loading report data:', error);
        // Use initial backend data already loaded
        console.log('Using initial backend data');
      }
    }

    function updateStats() {
      if (!reportData.stats) return;
      document.getElementById('totalSent').textContent = reportData.stats.total_sent.toLocaleString();
      document.getElementById('deliveryRate').textContent = reportData.stats.delivery_rate + '%';
      document.getElementById('failedCount').textContent = reportData.stats.failed_count.toLocaleString();
      document.getElementById('activeUsers').textContent = reportData.stats.active_users.toLocaleString();
    }

    function updateStats() {
      document.getElementById('totalSent').textContent = reportData.stats.total_sent.toLocaleString();
      document.getElementById('deliveryRate').textContent = reportData.stats.delivery_rate + '%';
      document.getElementById('failedCount').textContent = reportData.stats.failed_count.toLocaleString();
      document.getElementById('activeUsers').textContent = reportData.stats.active_users.toLocaleString();
    }

    function initializeCharts() {
      // Check if data is available
      if (!reportData.delivery_trends || !reportData.categories) {
        console.warn('Report data not loaded yet');
        return;
      }

      // Delivery Trends Chart
      const deliveryCtx = document.getElementById('deliveryChart').getContext('2d');
      deliveryChart = new Chart(deliveryCtx, {
        type: 'line',
        data: {
          labels: reportData.delivery_trends.map(d => new Date(d.date).toLocaleDateString()),
          datasets: [
            {
              label: 'Sent',
              data: reportData.delivery_trends.map(d => d.sent),
              borderColor: 'rgb(59, 130, 246)',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4
            },
            {
              label: 'Delivered',
              data: reportData.delivery_trends.map(d => d.delivered),
              borderColor: 'rgb(16, 185, 129)',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.4
            },
            {
              label: 'Failed',
              data: reportData.delivery_trends.map(d => d.failed),
              borderColor: 'rgb(239, 68, 68)',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // Category Chart
      const categoryCtx = document.getElementById('categoryChart').getContext('2d');
      categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
          labels: reportData.categories.map(c => c.name),
          datasets: [{
            data: reportData.categories.map(c => c.count),
            backgroundColor: [
              'rgb(59, 130, 246)',
              'rgb(16, 185, 129)',
              'rgb(245, 158, 11)',
              'rgb(239, 68, 68)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    function updateCharts() {
      // Check if charts exist and data is available
      if (!reportData.delivery_trends || !reportData.categories) {
        console.warn('Report data not available for charts');
        return;
      }

      // Update Delivery Trends Chart
      if (deliveryChart) {
        deliveryChart.data.labels = reportData.delivery_trends.map(d => new Date(d.date).toLocaleDateString());
        deliveryChart.data.datasets[0].data = reportData.delivery_trends.map(d => d.sent);
        deliveryChart.data.datasets[1].data = reportData.delivery_trends.map(d => d.delivered);
        deliveryChart.data.datasets[2].data = reportData.delivery_trends.map(d => d.failed);
        deliveryChart.update();
      }

      // Update Category Chart
      if (categoryChart) {
        categoryChart.data.labels = reportData.categories.map(c => c.name);
        categoryChart.data.datasets[0].data = reportData.categories.map(c => c.count);
        categoryChart.update();
      }
    }

    async function generateReport() {
      const reportType = document.getElementById('reportType').value;
      const dateRange = document.getElementById('dateRange').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      try {
        const params = new URLSearchParams({
          type: reportType,
          range: dateRange,
          start: startDate,
          end: endDate
        });
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const response = await fetch(`/api/reports/generate/?${params}`, {
          headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          
          // Update report data if it includes stats
          if (data.stats) {
            reportData.stats = data.stats;
            updateStats();
          }
          
          // Update charts if data includes trends
          if (data.delivery_trends) {
            reportData.delivery_trends = data.delivery_trends;
            updateCharts();
          }
          
          // Render table based on report type
          renderReportTable(data, reportType);
        } else {
          // Fallback to mock data
          const mockData = generateMockReportData(reportType);
          renderReportTable(mockData, reportType);
        }
      } catch (error) {
        console.error('Error generating report:', error);
        const mockData = generateMockReportData(reportType);
        renderReportTable(mockData, reportType);
      }
    }

    function generateMockReportData(reportType) {
      switch (reportType) {
        case 'delivery':
          return {
            headers: ['Date', 'Messages Sent', 'Delivered', 'Failed', 'Delivery Rate'],
            data: reportData.delivery_trends.map(d => [
              new Date(d.date).toLocaleDateString(),
              d.sent,
              d.delivered,
              d.failed,
              ((d.delivered / d.sent) * 100).toFixed(1) + '%'
            ])
          };
        
        case 'usage':
          return {
            headers: ['User', 'Role', 'Messages Sent', 'Last Activity', 'Status'],
            data: [
              ['admin@test.com', 'Admin', 2547, '2025-01-15 14:30', 'Active'],
              ['teacher1@school.com', 'Teacher', 1823, '2025-01-15 12:15', 'Active'],
              ['teacher2@school.com', 'Teacher', 1456, '2025-01-14 16:45', 'Active'],
              ['principal@school.com', 'Admin', 892, '2025-01-15 09:20', 'Active'],
              ['coordinator@school.com', 'Staff', 634, '2025-01-13 11:30', 'Inactive']
            ]
          };
        
        case 'user_activity':
          return {
            headers: ['Date', 'Logins', 'Messages Sent', 'Failed Attempts', 'Peak Hour'],
            data: [
              ['2025-01-15', 45, 1680, 3, '14:00-15:00'],
              ['2025-01-14', 42, 1560, 2, '10:00-11:00'],
              ['2025-01-13', 38, 1420, 5, '15:00-16:00'],
              ['2025-01-12', 35, 1180, 1, '11:00-12:00'],
              ['2025-01-11', 40, 1340, 4, '13:00-14:00']
            ]
          };
        
        case 'financial':
          return {
            headers: ['Date', 'Messages', 'Cost per SMS', 'Total Cost', 'Budget Used'],
            data: [
              ['2025-01-15', 1680, '₹0.15', '₹252.00', '12.6%'],
              ['2025-01-14', 1560, '₹0.15', '₹234.00', '11.7%'],
              ['2025-01-13', 1420, '₹0.15', '₹213.00', '10.7%'],
              ['2025-01-12', 1180, '₹0.15', '₹177.00', '8.9%'],
              ['2025-01-11', 1340, '₹0.15', '₹201.00', '10.1%']
            ]
          };
        
        default:
          return { headers: [], data: [] };
      }
    }

    function renderReportTable(data, reportType) {
      const headersRow = document.getElementById('tableHeaders');
      const dataBody = document.getElementById('reportData');
      
      // Clear existing content
      headersRow.innerHTML = '';
      dataBody.innerHTML = '';
      
      // Handle API response format
      if (data.report_data) {
        // Real API data
        if (reportType === 'usage' && Array.isArray(data.report_data)) {
          // Usage report
          const headers = ['User', 'Role', 'Messages Sent', 'Last Activity', 'Status'];
          headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headersRow.appendChild(th);
          });
          
          data.report_data.forEach(item => {
            const tr = document.createElement('tr');
            [item.user, item.role, item.messages_sent, item.last_activity, item.status].forEach(cell => {
              const td = document.createElement('td');
              td.textContent = cell;
              tr.appendChild(td);
            });
            dataBody.appendChild(tr);
          });
        } else if (reportType === 'user_activity' && Array.isArray(data.report_data)) {
          // User activity report
          const headers = ['Campaign', 'User', 'Status', 'Recipients', 'Sent', 'Delivered', 'Failed', 'Created'];
          headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headersRow.appendChild(th);
          });
          
          data.report_data.forEach(item => {
            const tr = document.createElement('tr');
            [item.campaign, item.user, item.status, item.recipients, item.sent, item.delivered, item.failed, item.created].forEach(cell => {
              const td = document.createElement('td');
              td.textContent = cell;
              tr.appendChild(td);
            });
            dataBody.appendChild(tr);
          });
        } else if (reportType === 'financial' && Array.isArray(data.report_data)) {
          // Financial report
          const headers = ['Month', 'Messages Sent', 'Cost (₹)'];
          headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headersRow.appendChild(th);
          });
          
          data.report_data.forEach(item => {
            const tr = document.createElement('tr');
            [item.month, item.messages_sent, '₹' + item.cost].forEach(cell => {
              const td = document.createElement('td');
              td.textContent = cell;
              tr.appendChild(td);
            });
            dataBody.appendChild(tr);
          });
        }
      } else if (data.delivery_trends) {
        // Delivery report from trends data
        const headers = ['Date', 'Messages Sent', 'Delivered', 'Failed', 'Delivery Rate'];
        headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = header;
          headersRow.appendChild(th);
        });
        
        data.delivery_trends.forEach(d => {
          const tr = document.createElement('tr');
          const deliveryRate = d.sent > 0 ? ((d.delivered / d.sent) * 100).toFixed(1) + '%' : '0%';
          [new Date(d.date).toLocaleDateString(), d.sent, d.delivered, d.failed, deliveryRate].forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell;
            tr.appendChild(td);
          });
          dataBody.appendChild(tr);
        });
      } else if (data.headers && data.data) {
        // Legacy mock data format
        data.headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = header;
          headersRow.appendChild(th);
        });
        
        data.data.forEach(row => {
          const tr = document.createElement('tr');
          row.forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell;
            tr.appendChild(td);
          });
          dataBody.appendChild(tr);
        });
      }
    }

    function exportReport(format) {
      const reportType = document.getElementById('reportType').value;
      const dateRange = document.getElementById('dateRange').value;
      const table = document.getElementById('reportTable');
      const fileName = `${reportType}_report_${new Date().toISOString().split('T')[0]}`;
      
      // Get headers and data
      const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
      const rows = Array.from(table.querySelectorAll('tbody tr'));
      const tableData = rows.map(row => 
        Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim())
      );
      
      if (format === 'csv') {
        // Create CSV with proper formatting for Excel
        let csv = '\uFEFF';  // UTF-8 BOM for Excel compatibility
        
        // Add headers
        csv += headers.map(h => `"${h}"`).join(',') + '\n';
        
        // Add data rows with proper escaping and date formatting
        tableData.forEach(row => {
          const formattedRow = row.map((cell, index) => {
            const cellStr = String(cell);
            
            // Check if this is a date/time column by header name or pattern
            const headerName = headers[index] ? headers[index].toLowerCase() : '';
            const isDateTimeColumn = headerName.includes('date') || 
                                     headerName.includes('time') || 
                                     headerName.includes('activity') ||
                                     headerName === 'date';
            
            // Match various date and datetime patterns
            const looksLikeDate = cellStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}/) || 
                                 cellStr.match(/^\d{4}-\d{2}-\d{2}/) ||
                                 cellStr.match(/^\d{1,2}-\d{1,2}-\d{4}/) ||
                                 cellStr.match(/^\d{4}\/\d{2}\/\d{2}/) ||
                                 // Datetime patterns (with time)
                                 cellStr.match(/\d{1,2}:\d{2}/) ||
                                 cellStr.match(/\d{4}-\d{2}-\d{2}\s+\d{1,2}:\d{2}/) ||
                                 cellStr.match(/\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}/);
            
            // For date/time fields, use Excel formula format to preserve as text
            if (isDateTimeColumn || looksLikeDate) {
              // Use ="datetime" format to force Excel to treat as text
              return `="${cellStr}"`;
            }
            
            // For other fields, normal escaping
            const escaped = cellStr.replace(/"/g, '""');
            return `"${escaped}"`;
          });
          csv += formattedRow.join(',') + '\n';
        });
        
        // Download
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', `${fileName}.csv`);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showAlert('CSV report exported successfully!', 'success');
      } else if (format === 'pdf') {
        try {
          // Initialize jsPDF
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF('p', 'mm', 'a4');
          
          // Add title
          doc.setFontSize(18);
          doc.setFont(undefined, 'bold');
          const title = `${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report`;
          doc.text(title, 14, 20);
          
          // Add date info
          doc.setFontSize(10);
          doc.setFont(undefined, 'normal');
          const dateText = `Generated on: ${new Date().toLocaleDateString()} | Range: ${dateRange}`;
          doc.text(dateText, 14, 28);
          
          // Add stats summary if available
          const totalSent = document.getElementById('totalSent')?.textContent || 'N/A';
          const deliveryRate = document.getElementById('deliveryRate')?.textContent || 'N/A';
          const failedCount = document.getElementById('failedCount')?.textContent || 'N/A';
          
          doc.setFontSize(9);
          doc.text(`Total Sent: ${totalSent} | Delivery Rate: ${deliveryRate} | Failed: ${failedCount}`, 14, 34);
          
          // Add table
          doc.autoTable({
            head: [headers],
            body: tableData,
            startY: 40,
            theme: 'grid',
            styles: {
              fontSize: 8,
              cellPadding: 3,
            },
            headStyles: {
              fillColor: [59, 130, 246],
              textColor: 255,
              fontStyle: 'bold',
            },
            alternateRowStyles: {
              fillColor: [245, 247, 250],
            },
            margin: { left: 14, right: 14 },
          });
          
          // Add footer
          const pageCount = doc.internal.getNumberOfPages();
          for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(128);
            doc.text(
              `Page ${i} of ${pageCount} | SMS Portal - ${new Date().toLocaleDateString()}`,
              doc.internal.pageSize.width / 2,
              doc.internal.pageSize.height - 10,
              { align: 'center' }
            );
          }
          
          // Save PDF
          doc.save(`${fileName}.pdf`);
          showAlert('PDF report exported successfully!', 'success');
        } catch (error) {
          console.error('PDF export error:', error);
          showAlert('Error exporting PDF. Please try again.', 'error');
        }
      }
    }

    function showAlert(message, type = 'success') {
      // Create a Bootstrap-style alert
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '20px';
      alertDiv.style.right = '20px';
      alertDiv.style.zIndex = '9999';
      alertDiv.style.minWidth = '300px';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alertDiv);
      
      // Auto remove after 3 seconds
      setTimeout(() => {
        alertDiv.remove();
      }, 3000);
    }

    // Event listeners
    document.getElementById('dateRange').addEventListener('change', function() {
      const customFields = ['startDate', 'endDate'];
      const isCustom = this.value === 'custom';
      
      customFields.forEach(field => {
        const element = document.getElementById(field);
        element.disabled = !isCustom;
        if (isCustom && !element.value) {
          const date = new Date();
          if (field === 'endDate') {
            element.value = date.toISOString().split('T')[0];
          } else {
            date.setDate(date.getDate() - 7);
            element.value = date.toISOString().split('T')[0];
          }
        }
      });
    });

    // Report type change listener
    document.getElementById('reportType').addEventListener('change', function() {
      generateReport();
    });

    // Date range change listener
    document.getElementById('dateRange').addEventListener('change', function() {
      generateReport();
    });

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initializeDashboard);
  </script>

  <script>
    // Cache-first sidebar loading
    (function(){
      const CACHE_KEY = 'sidebar_html_v1';
      const CACHE_TTL_KEY = 'sidebar_html_v1_ttl';
      const CACHE_TTL_MS = 1000 * 60 * 30;

      function getCsrfToken() {
        const cookieValue = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
        if (cookieValue) return cookieValue.split('=')[1];
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag) return metaTag.getAttribute('content');
        return null;
      }

      function injectSidebar(html) {
        const container = document.getElementById('sidebarContainer');
        if (!container) return;
        container.innerHTML = html;
        const csrfToken = getCsrfToken();
        if (csrfToken) {
          const forms = container.querySelectorAll('form');
          forms.forEach(form => {
            const tokenInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
            if (tokenInput) tokenInput.value = csrfToken;
          });
        }
      }

      function fetchAndCache() {
        return fetch('/sidebar/', { credentials: 'same-origin' })
          .then(r => { if (!r.ok) throw new Error('Failed to load'); return r.text(); })
          .then(html => {
            try {
              sessionStorage.setItem(CACHE_KEY, html);
              sessionStorage.setItem(CACHE_TTL_KEY, String(Date.now() + CACHE_TTL_MS));
            } catch (e) {}
            injectSidebar(html);
          })
          .catch(err => console.error('Sidebar load failed:', err));
      }

      try {
        const cached = sessionStorage.getItem(CACHE_KEY);
        const ttl = parseInt(sessionStorage.getItem(CACHE_TTL_KEY) || '0', 10);
        if (cached && Date.now() < ttl) {
          injectSidebar(cached);
          fetchAndCache();
        } else {
          fetchAndCache();
        }
      } catch (e) {
        fetchAndCache();
      }
    })();
  </script>
</body>
</html>
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Send SMS | SMS Portal</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    body { background:#f8f9fa }
    .header { background:#fff;padding:15px 25px;box-shadow:0 2px 4px rgba(0,0,0,.05) }
    .card { border:none;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,.05) }
    .preview-table th,.preview-table td{font-size:.9rem;vertical-align:middle}
  </style>
</head>

<body>
<script>window.API_BASE='{{ API_BASE }}'</script>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-2 p-0" id="sidebarContainer">
      <noscript>{% include 'includes/sidebar.html' with role=user_role %}</noscript>
    </div>

    <div class="col-md-10">
      <div class="header d-flex justify-content-between">
        <div>
          <h4 class="mb-0">Send SMS</h4>
          <small class="text-muted">Compose and personalize messages</small>
        </div>
        <div class="text-end">
          <small class="text-muted">Signed in as</small><br>
          <strong>{{ user.email }}</strong>
        </div>
      </div>

      <div class="container mt-4">

        <!-- Stats -->
        <div class="row g-3 mb-4">
          <div class="col-md-3"><div class="card p-3 text-center"><h6>Messages Today</h6><h4 id="todayCount">0</h4></div></div>
          <div class="col-md-3"><div class="card p-3 text-center"><h6>Remaining Credits</h6><h4 id="remainingCredits">0</h4></div></div>
          <div class="col-md-3"><div class="card p-3 text-center"><h6>Delivery Rate</h6><h4 id="deliveryRate">0%</h4></div></div>
          <div class="col-md-3"><div class="card p-3 text-center"><h6>Cost / SMS</h6><h4>₹0.15</h4></div></div>
        </div>

        <!-- Form -->
        <div class="card p-4 mb-5">
          <form id="smsForm">

            <div class="mb-3">
              <label class="form-label">Campaign</label>
              <select id="campaignSelect" class="form-select"></select>
            </div>

            <div class="mb-3">
              <label class="form-label">Template</label>
              <select id="templateSelect" class="form-select"></select>
            </div>

            <div class="mb-3">
              <label class="form-label">Group</label>
              <select id="groupSelect" class="form-select"></select>
            </div>

            <div id="variableInputs" class="row g-3 mb-4"></div>

            <div class="mb-3">
              <h6>Preview</h6>
              <table class="table table-bordered preview-table">
                <thead><tr><th>#</th><th>Name</th><th>Phone</th><th>Message</th></tr></thead>
                <tbody id="previewBody"></tbody>
              </table>
            </div>

            <div class="text-end">
              <button class="btn btn-primary" id="sendBtn">
                <i class="fas fa-paper-plane me-2"></i>Send SMS
              </button>
            </div>

          </form>
        </div>

      </div>
    </div>
  </div>
</div>

<meta name="csrf-token" content="{{ csrf_token }}">

<script>
/* ===================== STATE ===================== */
let templates=[],groups=[],contacts=[],selectedTemplate=null;
let variableValues={};

/* ===================== UTILS ===================== */
function normalize(name){
  return name.toLowerCase().replace(/[\s_]+/g,'');
}

/* ===================== INIT ===================== */
document.addEventListener("DOMContentLoaded",()=>{
  fetchJSON('/templates/',d=>{
    populate('templateSelect',templates=d,'title');
  });
  fetchJSON('/groups/',d=>populate('groupSelect',groups=d,'name'));
  fetchJSON('/campaigns/',d=>populate('campaignSelect',d,'title'));
  fetchJSON('/send/stats/',s=>{
    todayCount.textContent=s.today_count;
    remainingCredits.textContent=s.remaining_credits;
    deliveryRate.textContent=s.delivery_rate+'%';
  });
});

/* ===================== FETCH ===================== */
function fetchJSON(url,cb){
  fetch(API_BASE+url,{credentials:'include'})
    .then(r=>r.ok&&r.json())
    .then(d=>d&&cb(d));
}

/* ===================== UI ===================== */
function populate(id,data,label){
  const el=document.getElementById(id);
  el.innerHTML='<option value="">-- Select --</option>';
  data.forEach(i=>el.insertAdjacentHTML('beforeend',
    `<option value="${i.id}">${i[label]}</option>`));
}

/* ===================== TEMPLATE ===================== */
templateSelect.onchange=()=>{
  selectedTemplate=templates.find(t=>t.id==templateSelect.value);
  if(!selectedTemplate) return;
  renderVariableInputs(selectedTemplate.variable_schema);
  renderPreview();
};

groupSelect.onchange=()=>{
  fetchJSON(`/groups/${groupSelect.value}/contacts/`,d=>{
    contacts=d.contacts||[];
    renderPreview();
  });
};

/* ===================== VARIABLES ===================== */
function renderVariableInputs(schema){
  variableValues = {};
  variableInputs.innerHTML = '';
  if (!schema) return;

  Object.keys(schema).forEach(varName => {
    const varConfig = schema[varName];
    const dataType = varConfig.type || 'string';
    
    // Map data types to HTML input types
    let inputType = 'text';
    if (dataType === 'float' || dataType === 'number' || dataType === 'integer') {
      inputType = 'number';
    } else if (dataType === 'date') {
      inputType = 'date';
    } else if (dataType === 'time') {
      inputType = 'time';
    } else if (dataType === 'email') {
      inputType = 'email';
    }
    
    // Add step attribute for float types
    const stepAttr = dataType === 'float' ? 'step="0.01"' : '';
    const minAttr = varConfig.min !== undefined ? `min="${varConfig.min}"` : '';
    const maxAttr = varConfig.max !== undefined ? `max="${varConfig.max}"` : '';
    const maxLengthAttr = varConfig.max_length ? `maxlength="${varConfig.max_length}"` : '';
    const requiredAttr = varConfig.required ? 'required' : '';
    
    variableInputs.insertAdjacentHTML('beforeend', `
      <div class="col-md-4">
        <label class="form-label">${varName} <small class="text-muted">(${dataType})</small></label>
        <input class="form-control" type="${inputType}" ${stepAttr} ${minAttr} ${maxAttr} ${maxLengthAttr} ${requiredAttr}
          placeholder="Enter ${varName}"
          oninput="setVar('${varName}', this.value)">
      </div>
    `);
  });
}


function setVar(varName, value) {
  variableValues[varName] = value;
  renderPreview();
}


/* ===================== RENDER ===================== */
function applyVars(text) {
  let out = text;

  Object.entries(variableValues).forEach(([key, value]) => {
    const escaped = key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(`\\{#${escaped}#\\}`, 'g');
    out = out.replace(regex, value ?? '');
  });

  return out;
}


function renderPreview(){
  const body=document.getElementById('previewBody');
  body.innerHTML='';
  if(!selectedTemplate||!contacts.length) return;

  contacts.forEach((c,i)=>{
    body.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i+1}</td>
        <td>${c.name}</td>
        <td>${c.phone_number}</td>
        <td>${applyVars(selectedTemplate.content)}</td>
      </tr>
    `);
  });
}

/* ===================== SUBMIT ===================== */
smsForm.onsubmit=async e=>{
  e.preventDefault();
  if(!selectedTemplate||!contacts.length) return alert('Select template & group');

  const msg=applyVars(selectedTemplate.content);
  const payload={
    template_id:selectedTemplate.id,
    recipients:contacts.map(c=>c.phone_number),
    message:msg,
    sender_id:'BOMBYS',
    campaign_id:campaignSelect.value||null
  };

  sendBtn.disabled=true;
  sendBtn.innerHTML='Sending…';

  try{
    const r=await fetch('/api/sms/send/',{
      method:'POST',
      credentials:'include',
      headers:{
        'Content-Type':'application/json',
        'X-CSRFToken':document.querySelector('[name=csrf-token]').content
      },
      body:JSON.stringify(payload)
    });
    const j=await r.json();
    if(!j.success) throw j;
    alert('SMS sent!');
    location.href='/history/';
  }catch{
    alert('Failed to send');
    sendBtn.disabled=false;
    sendBtn.innerHTML='Send SMS';
  }
};
</script>

<!-- ✅ SIDEBAR CACHE SCRIPT (ADDED BACK, UNCHANGED) -->
<script>
(function(){
  const CACHE_KEY='sidebar_html_v1';
  const CACHE_TTL_KEY='sidebar_html_v1_ttl';
  const TTL=1000*60*30;

  function csrf(){
    const c=document.cookie.split('; ').find(r=>r.startsWith('csrftoken='));
    return c?c.split('=')[1]:null;
  }

  function inject(html){
    sidebarContainer.innerHTML=html;
    const t=csrf();
    if(!t) return;
    sidebarContainer.querySelectorAll('input[name=csrfmiddlewaretoken]')
      .forEach(i=>i.value=t);
  }

  function load(){
    return fetch('/sidebar/',{credentials:'same-origin'})
      .then(r=>r.text())
      .then(h=>{
        sessionStorage.setItem(CACHE_KEY,h);
        sessionStorage.setItem(CACHE_TTL_KEY,Date.now()+TTL);
        inject(h);
      });
  }

  const cached=sessionStorage.getItem(CACHE_KEY);
  const ttl=+sessionStorage.getItem(CACHE_TTL_KEY);
  if(cached && Date.now()<ttl){
    inject(cached);
    load();
  }else load();
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

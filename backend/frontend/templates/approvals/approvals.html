{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SMS Portal â€” Template Approvals</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; min-height: 100vh; }
    .sidebar a.active { background-color: #3b82f6 !important; }
    .header { background-color: white; padding: 15px 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .template-preview { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; font-family: monospace; }
    .status-pending { color: #f59e0b; }
    .status-approved { color: #10b981; }
    .status-rejected { color: #ef4444; }
    .approval-actions { gap: 0.5rem; }
  </style>
</head>
<body>
  <script>window.API_BASE = '{{ API_BASE }}';</script>

  <div class="container-fluid">
    <div class="row">
      <div class="col-md-2 p-0" id="sidebarContainer">
        {% include 'includes/sidebar.html' %}
      </div>

      <div class="col-md-10">
        <div class="header d-flex justify-content-between align-items-center">
          <div>
            <h4 class="mb-0">Template Approvals</h4>
            <div style="font-size: .85rem; color: #6b7280;">Review and approve SMS templates for compliance</div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="refreshData()">
              <i class="fas fa-refresh"></i> Refresh
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkActionModal">
              <i class="fas fa-check-double"></i> Bulk Actions
            </button>
          </div>
        </div>

        <div class="container mt-4">
          <!-- Stats Cards -->
          <div class="row g-3 mb-4">
            <div class="col-md-3">
              <div class="card text-center p-3">
                <h6>Pending Review</h6>
                <h3 class="text-warning" id="pendingCount">0</h3>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center p-3">
                <h6>Approved Today</h6>
                <h3 class="text-success" id="approvedTodayCount">0</h3>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center p-3">
                <h6>Rejected</h6>
                <h3 class="text-danger" id="rejectedCount">0</h3>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center p-3">
                <h6>Total Templates</h6>
                <h3 class="text-info" id="totalCount">0</h3>
              </div>
            </div>
          </div>

          <!-- Filters -->
          <div class="card mb-4">
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-3">
                  <select class="form-select" id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <select class="form-select" id="categoryFilter">
                    <option value="">All Categories</option>
                    <option value="academic">Academic</option>
                    <option value="administrative">Administrative</option>
                    <option value="event">Event</option>
                    <option value="emergency">Emergency</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <select class="form-select" id="priorityFilter">
                    <option value="">All Priorities</option>
                    <option value="high">High Priority</option>
                    <option value="medium">Medium Priority</option>
                    <option value="low">Low Priority</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <input type="text" class="form-control" placeholder="Search templates..." id="searchTemplates">
                </div>
              </div>
            </div>
          </div>

          <!-- Templates List -->
          <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Template Submissions</h5>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                <label class="form-check-label" for="selectAll">Select All</label>
              </div>
            </div>
            <div class="card-body p-0">
              <div id="templatesList">
                <!-- Templates will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Template Details Modal -->
  <div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="templateModalTitle">Template Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="templateModalBody">
          <!-- Template details will be loaded here -->
        </div>
        <div class="modal-footer" id="templateModalFooter">
          <!-- Action buttons will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Action Modal -->
  <div class="modal fade" id="bulkActionModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Bulk Actions</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Apply action to selected templates:</p>
          <div class="mb-3">
            <select class="form-select" id="bulkAction">
              <option value="">Select Action</option>
              <option value="approve">Approve All</option>
              <option value="reject">Reject All</option>
              <option value="priority">Change Priority</option>
            </select>
          </div>
          <div class="mb-3" id="priorityOptions" style="display: none;">
            <label class="form-label">New Priority</label>
            <select class="form-select" id="newPriority">
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
          </div>
          <div class="mb-3" id="rejectionReason" style="display: none;">
            <label class="form-label">Rejection Reason</label>
            <textarea class="form-control" id="bulkRejectionReason" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="executeBulkAction()">Apply Action</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let templates = [];
    let selectedTemplates = new Set();

    // Load templates from API
    async function loadTemplates() {
      try {
        const response = await window.AppAuth.authFetch(window.AppAuth.API_BASE + '/template-approvals/');
        if (response.ok) {
          templates = await response.json();
        }
      } catch (error) {
        console.error('Error loading templates:', error);
        // Mock data for demo
        templates = [
          {
            id: 1,
            title: 'Exam Schedule Notification',
            content: 'Dear Student, Your upcoming exam for {{subject}} is scheduled on {{date}} at {{time}}. Venue: {{venue}}. Please carry your ID card and required materials.',
            category: 'academic',
            priority: 'high',
            status: 'pending',
            submitted_by: 'Prof. Smith',
            submitted_at: '2025-01-15T10:30:00Z',
            variables: ['subject', 'date', 'time', 'venue'],
            usage_count: 0,
            compliance_notes: 'Requires approval for academic notifications'
          },
          {
            id: 2,
            title: 'Fee Payment Reminder',
            content: 'Dear Parent/Student, This is a reminder that your fee payment of Rs. {{amount}} is due on {{due_date}}. Please pay to avoid late fees.',
            category: 'administrative',
            priority: 'medium',
            status: 'approved',
            submitted_by: 'Accounts Dept',
            submitted_at: '2025-01-14T14:20:00Z',
            approved_by: 'Admin',
            approved_at: '2025-01-14T15:00:00Z',
            variables: ['amount', 'due_date'],
            usage_count: 25,
            compliance_notes: 'Approved for financial communications'
          },
          {
            id: 3,
            title: 'Event Invitation',
            content: 'Join us for {{event_name}} on {{date}} at {{venue}}. Time: {{time}}. Special guests: {{guests}}. RSVP by {{rsvp_date}}.',
            category: 'event',
            priority: 'low',
            status: 'pending',
            submitted_by: 'Events Team',
            submitted_at: '2025-01-15T09:15:00Z',
            variables: ['event_name', 'date', 'venue', 'time', 'guests', 'rsvp_date'],
            usage_count: 0,
            compliance_notes: 'Pending review for event communications'
          },
          {
            id: 4,
            title: 'Emergency Alert',
            content: 'URGENT: {{message}}. All students and staff are advised to {{action}}. For updates, contact {{contact_number}}.',
            category: 'emergency',
            priority: 'high',
            status: 'rejected',
            submitted_by: 'Security Dept',
            submitted_at: '2025-01-13T16:45:00Z',
            rejected_by: 'Compliance Officer',
            rejected_at: '2025-01-13T17:00:00Z',
            rejection_reason: 'Template too vague, needs specific emergency protocols',
            variables: ['message', 'action', 'contact_number'],
            usage_count: 0,
            compliance_notes: 'Rejected - requires revision'
          },
          {
            id: 5,
            title: 'Holiday Notice',
            content: 'The institution will remain closed on {{date}} due to {{reason}}. Classes will resume on {{resume_date}}.',
            category: 'administrative',
            priority: 'medium',
            status: 'approved',
            submitted_by: 'Admin Office',
            submitted_at: '2025-01-12T11:00:00Z',
            approved_by: 'Principal',
            approved_at: '2025-01-12T12:30:00Z',
            variables: ['date', 'reason', 'resume_date'],
            usage_count: 5,
            compliance_notes: 'Approved for institutional announcements'
          }
        ];
      }
      renderTemplates();
      updateStats();
    }

    function renderTemplates(filteredTemplates = templates) {
      const container = document.getElementById('templatesList');
      container.innerHTML = '';

      if (filteredTemplates.length === 0) {
        container.innerHTML = '<div class="text-center py-4"><p class="text-muted">No templates found</p></div>';
        return;
      }

      filteredTemplates.forEach(template => {
        const statusBadge = getStatusBadge(template.status);
        const priorityBadge = getPriorityBadge(template.priority);
        
        // Build content preview
        const contentPreview = template.content.length > 150 ? 
          template.content.substring(0, 150) + '...' : template.content;
        
        // Build action buttons based on status
        let actionButtons = '<button class="btn btn-sm btn-outline-primary" onclick="viewTemplate(' + template.id + ')">View</button>';
        
        if (template.status === 'pending') {
          actionButtons += '<button class="btn btn-sm btn-success" onclick="approveTemplate(' + template.id + ')">Approve</button>';
          actionButtons += '<button class="btn btn-sm btn-danger" onclick="rejectTemplate(' + template.id + ')">Reject</button>';
        } else if (template.status === 'approved') {
          actionButtons += '<button class="btn btn-sm btn-warning" onclick="revokeTemplate(' + template.id + ')">Revoke</button>';
        }
        
        // Build date information
        let dateInfo = 'Submitted: ' + new Date(template.submitted_at).toLocaleString();
        if (template.approved_at) {
          dateInfo += ' | Approved: ' + new Date(template.approved_at).toLocaleString();
        }
        if (template.rejected_at) {
          dateInfo += ' | Rejected: ' + new Date(template.rejected_at).toLocaleString();
        }
        
        const templateRow = document.createElement('div');
        templateRow.className = 'border-bottom p-3';
        templateRow.innerHTML = 
          '<div class="row align-items-start">' +
            '<div class="col-auto">' +
              '<div class="form-check">' +
                '<input class="form-check-input template-checkbox" type="checkbox" value="' + template.id + '" onchange="updateSelection()">' +
              '</div>' +
            '</div>' +
            '<div class="col">' +
              '<div class="d-flex justify-content-between align-items-start mb-2">' +
                '<h6 class="mb-0">' + template.title + '</h6>' +
                '<div class="d-flex gap-2">' +
                  statusBadge + priorityBadge +
                '</div>' +
              '</div>' +
              '<div class="template-preview mb-3">' + contentPreview + '</div>' +
              '<div class="row text-small text-muted mb-2">' +
                '<div class="col-md-3"><strong>Category:</strong> ' + template.category + '</div>' +
                '<div class="col-md-3"><strong>Submitted by:</strong> ' + template.submitted_by + '</div>' +
                '<div class="col-md-3"><strong>Variables:</strong> ' + template.variables.length + '</div>' +
                '<div class="col-md-3"><strong>Usage:</strong> ' + template.usage_count + ' times</div>' +
              '</div>' +
              '<div class="d-flex justify-content-between align-items-center">' +
                '<small class="text-muted">' + dateInfo + '</small>' +
                '<div class="approval-actions d-flex">' + actionButtons + '</div>' +
              '</div>' +
            '</div>' +
          '</div>';
        
        container.appendChild(templateRow);
      });
    }

    function getStatusBadge(status) {
      const badges = {
        'pending': '<span class="badge bg-warning">Pending</span>',
        'approved': '<span class="badge bg-success">Approved</span>',
        'rejected': '<span class="badge bg-danger">Rejected</span>'
      };
      return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
    }

    function getPriorityBadge(priority) {
      const badges = {
        'high': '<span class="badge bg-danger">High Priority</span>',
        'medium': '<span class="badge bg-warning">Medium Priority</span>',
        'low': '<span class="badge bg-info">Low Priority</span>'
      };
      return badges[priority] || '<span class="badge bg-secondary">Normal</span>';
    }

    function updateStats() {
      const pending = templates.filter(t => t.status === 'pending').length;
      const today = new Date().toDateString();
      const approvedToday = templates.filter(t => 
        t.status === 'approved' && 
        new Date(t.approved_at).toDateString() === today
      ).length;
      const rejected = templates.filter(t => t.status === 'rejected').length;

      document.getElementById('pendingCount').textContent = pending;
      document.getElementById('approvedTodayCount').textContent = approvedToday;
      document.getElementById('rejectedCount').textContent = rejected;
      document.getElementById('totalCount').textContent = templates.length;
    }

    function viewTemplate(id) {
      const template = templates.find(t => t.id === id);
      document.getElementById('templateModalTitle').textContent = template.title;
      
      const body = document.getElementById('templateModalBody');
      
      // Build variables HTML
      const variablesHtml = template.variables.map(v => 
        '<span class="badge bg-light text-dark me-1">{' + '{' + v + '}' + '}</span>'
      ).join('');
      
      // Build rejection reason HTML
      const rejectionHtml = template.rejection_reason ? 
        '<h6>Rejection Reason</h6><p class="text-danger">' + template.rejection_reason + '</p>' : '';
      
      body.innerHTML = 
        '<div class="row">' +
          '<div class="col-md-6">' +
            '<h6>Template Information</h6>' +
            '<p><strong>Category:</strong> ' + template.category + '</p>' +
            '<p><strong>Priority:</strong> ' + template.priority + '</p>' +
            '<p><strong>Status:</strong> ' + template.status + '</p>' +
            '<p><strong>Submitted by:</strong> ' + template.submitted_by + '</p>' +
            '<p><strong>Usage Count:</strong> ' + template.usage_count + '</p>' +
          '</div>' +
          '<div class="col-md-6">' +
            '<h6>Variables</h6>' +
            '<div class="mb-3">' + variablesHtml + '</div>' +
            rejectionHtml +
          '</div>' +
        '</div>' +
        '<h6>Template Content</h6>' +
        '<div class="template-preview mb-3">' + template.content + '</div>' +
        '<h6>Compliance Notes</h6>' +
        '<p class="text-muted">' + template.compliance_notes + '</p>';
      
      const footer = document.getElementById('templateModalFooter');
      
      // Build footer buttons
      const pendingButtons = template.status === 'pending' ? 
        '<button type="button" class="btn btn-success" onclick="approveTemplate(' + template.id + '); bootstrap.Modal.getInstance(document.getElementById(\'templateModal\')).hide();">Approve</button>' +
        '<button type="button" class="btn btn-danger" onclick="rejectTemplate(' + template.id + ')">Reject</button>' : '';
      
      footer.innerHTML = 
        '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>' +
        pendingButtons;
      
      new bootstrap.Modal(document.getElementById('templateModal')).show();
    }

    async function approveTemplate(id) {
      try {
        const response = await window.AppAuth.authFetch(window.AppAuth.API_BASE + '/template-approvals/' + id + '/approve/', {
          method: 'POST'
        });

        if (response.ok) {
          alert('Template approved successfully!');
          loadTemplates();
        } else {
          alert('Error approving template');
        }
      } catch (error) {
        console.error('Error approving template:', error);
        // Demo: simulate success
        const template = templates.find(t => t.id === id);
        template.status = 'approved';
        template.approved_by = 'Current User';
        template.approved_at = new Date().toISOString();
        renderTemplates();
        updateStats();
        alert('Template approved successfully! (Demo mode)');
      }
    }

    function rejectTemplate(id) {
      const reason = prompt('Enter rejection reason:');
      if (!reason) return;
      
      performRejectTemplate(id, reason);
    }

    async function performRejectTemplate(id, reason) {
      try {
        const response = await window.AppAuth.authFetch(window.AppAuth.API_BASE + '/template-approvals/' + id + '/reject/', {
          method: 'POST',
          body: JSON.stringify({ reason })
        });

        if (response.ok) {
          alert('Template rejected successfully!');
          loadTemplates();
        } else {
          alert('Error rejecting template');
        }
      } catch (error) {
        console.error('Error rejecting template:', error);
        // Demo: simulate success
        const template = templates.find(t => t.id === id);
        template.status = 'rejected';
        template.rejected_by = 'Current User';
        template.rejected_at = new Date().toISOString();
        template.rejection_reason = reason;
        renderTemplates();
        updateStats();
        alert('Template rejected successfully! (Demo mode)');
        
        if (bootstrap.Modal.getInstance(document.getElementById('templateModal'))) {
          bootstrap.Modal.getInstance(document.getElementById('templateModal')).hide();
        }
      }
    }

    async function revokeTemplate(id) {
      if (!confirm('Are you sure you want to revoke approval for this template?')) return;
      
      try {
        const response = await window.AppAuth.authFetch(window.AppAuth.API_BASE + '/template-approvals/' + id + '/revoke/', {
          method: 'POST'
        });

        if (response.ok) {
          alert('Template approval revoked!');
          loadTemplates();
        } else {
          alert('Error revoking template');
        }
      } catch (error) {
        console.error('Error revoking template:', error);
        // Demo: simulate success
        const template = templates.find(t => t.id === id);
        template.status = 'pending';
        delete template.approved_by;
        delete template.approved_at;
        renderTemplates();
        updateStats();
        alert('Template approval revoked! (Demo mode)');
      }
    }

    function updateSelection() {
      const checkboxes = document.querySelectorAll('.template-checkbox:checked');
      selectedTemplates = new Set(Array.from(checkboxes).map(cb => parseInt(cb.value)));
      
      const selectAllCheckbox = document.getElementById('selectAll');
      const totalCheckboxes = document.querySelectorAll('.template-checkbox').length;
      
      if (selectedTemplates.size === totalCheckboxes && totalCheckboxes > 0) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else if (selectedTemplates.size > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
    }

    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('.template-checkbox');
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
      });
      
      updateSelection();
    }

    function executeBulkAction() {
      const action = document.getElementById('bulkAction').value;
      if (!action || selectedTemplates.size === 0) {
        alert('Please select an action and templates');
        return;
      }
      
      switch (action) {
        case 'approve':
          selectedTemplates.forEach(id => approveTemplate(id));
          break;
        case 'reject':
          const reason = document.getElementById('bulkRejectionReason').value;
          if (!reason) {
            alert('Please enter rejection reason');
            return;
          }
          selectedTemplates.forEach(id => performRejectTemplate(id, reason));
          break;
        case 'priority':
          const newPriority = document.getElementById('newPriority').value;
          updatePriority(Array.from(selectedTemplates), newPriority);
          break;
      }
      
      bootstrap.Modal.getInstance(document.getElementById('bulkActionModal')).hide();
    }

    function updatePriority(ids, priority) {
      // Demo: update priority locally
      ids.forEach(id => {
        const template = templates.find(t => t.id === id);
        if (template) {
          template.priority = priority;
        }
      });
      renderTemplates();
      alert(`Priority updated for ${ids.length} templates! (Demo mode)`);
    }

    function refreshData() {
      loadTemplates();
      alert('Data refreshed!');
    }

    // Filter functionality
    document.getElementById('statusFilter').addEventListener('change', filterTemplates);
    document.getElementById('categoryFilter').addEventListener('change', filterTemplates);
    document.getElementById('priorityFilter').addEventListener('change', filterTemplates);
    document.getElementById('searchTemplates').addEventListener('input', filterTemplates);

    // Bulk action modal controls
    document.getElementById('bulkAction').addEventListener('change', function() {
      const action = this.value;
      document.getElementById('priorityOptions').style.display = action === 'priority' ? 'block' : 'none';
      document.getElementById('rejectionReason').style.display = action === 'reject' ? 'block' : 'none';
    });

    function filterTemplates() {
      const statusFilter = document.getElementById('statusFilter').value;
      const categoryFilter = document.getElementById('categoryFilter').value;
      const priorityFilter = document.getElementById('priorityFilter').value;
      const search = document.getElementById('searchTemplates').value.toLowerCase();
      
      let filtered = templates.filter(template => {
        const matchesStatus = !statusFilter || template.status === statusFilter;
        const matchesCategory = !categoryFilter || template.category === categoryFilter;
        const matchesPriority = !priorityFilter || template.priority === priorityFilter;
        const matchesSearch = !search || 
          template.title.toLowerCase().includes(search) ||
          template.content.toLowerCase().includes(search) ||
          template.submitted_by.toLowerCase().includes(search);
        
        return matchesStatus && matchesCategory && matchesPriority && matchesSearch;
      });
      
      renderTemplates(filtered);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', loadTemplates);
  </script>
</body>
</html>
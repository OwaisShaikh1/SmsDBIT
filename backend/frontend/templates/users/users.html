{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SMS Portal — Manage Users</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background-color: #f8f9fa; min-height: 100vh; }
    .sidebar a.active { background-color: #3b82f6 !important; }
    .header { background-color: white; padding: 15px 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .user-avatar { width: 40px; height: 40px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .status-badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
    .small-muted { font-size: .85rem; color: #6b7280; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">

      <!-- Sidebar (corrected version) -->
      <div class="col-md-2 p-0" id="sidebarContainer">
        <noscript>{% include 'includes/sidebar.html' with role=request.user.role %}</noscript>
      </div>

      <script>
        // Cache-first sidebar loading - runs immediately
        (function(){
          const CACHE_KEY = 'sidebar_html_v1';
          const CACHE_TTL_KEY = 'sidebar_html_v1_ttl';
          const CACHE_TTL_MS = 1000 * 60 * 30;

          function getCsrfToken() {
            const cookieValue = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
            if (cookieValue) return cookieValue.split('=')[1];
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag) return metaTag.getAttribute('content');
            return null;
          }

          function injectSidebar(html) {
            const container = document.getElementById('sidebarContainer');
            if (!container) return;
            container.innerHTML = html;
            const csrfToken = getCsrfToken();
            if (csrfToken) {
              const forms = container.querySelectorAll('form');
              forms.forEach(form => {
                const tokenInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
                if (tokenInput) tokenInput.value = csrfToken;
              });
            }
          }

          function fetchAndCache() {
            return fetch('/sidebar/', { credentials: 'same-origin' })
              .then(r => { if (!r.ok) throw new Error('Failed to load'); return r.text(); })
              .then(html => {
                try {
                  sessionStorage.setItem(CACHE_KEY, html);
                  sessionStorage.setItem(CACHE_TTL_KEY, String(Date.now() + CACHE_TTL_MS));
                } catch (e) {}
                injectSidebar(html);
              })
              .catch(err => console.error('Sidebar load failed:', err));
          }

          try {
            const cached = sessionStorage.getItem(CACHE_KEY);
            const ttl = parseInt(sessionStorage.getItem(CACHE_TTL_KEY) || '0', 10);
            if (cached && Date.now() < ttl) {
              injectSidebar(cached);
              fetchAndCache();
            } else {
              fetchAndCache();
            }
          } catch (e) {
            fetchAndCache();
          }
        })();
      </script>

      <!-- Main -->
      <div class="col-md-10">
        <!-- Header -->
        <div class="header d-flex justify-content-between align-items-center">
          <div>
            <h4 class="mb-0">Manage Users</h4>
            <div class="small-muted">Welcome, {{ request.user.username }} • <strong>{{ request.user.role|capfirst }}</strong></div>
          </div>
          <div class="text-end">
            <div class="small-muted">Signed in as</div>
            <div><strong>{{ request.user.email }}</strong></div>
          </div>
        </div>

        <!-- Body -->
        <div class="container mt-4">
          <!-- KPI Cards -->
          <div class="row g-3 mb-4">
            <div class="col-md-3"><div class="card text-center p-3"><h6>Total Users</h6><h3 class="text-primary">{{ stats.total }}</h3></div></div>
            <div class="col-md-3"><div class="card text-center p-3"><h6>Active Users</h6><h3 class="text-success">{{ stats.active }}</h3></div></div>
            <div class="col-md-3"><div class="card text-center p-3"><h6>Admins</h6><h3 class="text-info">{{ stats.admins }}</h3></div></div>
            <div class="col-md-3"><div class="card text-center p-3"><h6>Teachers</h6><h3 class="text-warning">{{ stats.teachers }}</h3></div></div>
          </div>

          <!-- Users Table -->
          <div class="card mb-5">
            <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
              <span>System Users</span>
              <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createUserModal">
                <i class="fa fa-plus"></i> Add New User
              </button>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>User</th>
                      <th>Email</th>
                      <th>Role</th>
                      <th>Status</th>
                      <th>Last Login</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="usersTableBody">

                    {% if users %}
                      {% for user in users %}
                        <tr>
                          <td>
                            <div class="d-flex align-items-center">
                              <div class="user-avatar me-3">{{ user.first_name|first|upper }}{{ user.last_name|first|upper }}</div>
                              <div>
                                <div class="fw-medium">{{ user.first_name }} {{ user.last_name }}</div>
                                <div class="text-muted small">@{{ user.username }}</div>
                              </div>
                            </div>
                          </td>
                          <td>{{ user.email }}</td>
                          <td>
                            <span class="badge {% if user.role == 'admin' %}bg-danger{% else %}bg-primary{% endif %} status-badge">
                              {{ user.role|capfirst }}
                            </span>
                          </td>
                          <td>
                            {% if user.is_active %}
                              <span class="badge bg-success status-badge">Active</span>
                            {% else %}
                              <span class="badge bg-danger status-badge">Inactive</span>
                            {% endif %}
                          </td>
                          <td>{{ user.last_login|date:"d M Y, H:i"|default:"Never" }}</td>
                          <td>
                            {% if request.user.role == 'admin' %}
                              {% if user.is_active %}
                                <button class="btn btn-sm btn-danger userActionBtn" data-user-id="{{ user.id }}" data-action="deactivate">Deactivate</button>
                              {% else %}
                                <button class="btn btn-sm btn-success userActionBtn" data-user-id="{{ user.id }}" data-action="activate">Activate</button>
                              {% endif %}
                            {% else %}
                              -
                            {% endif %}
                          </td>
                        </tr>
                      {% endfor %}
                    {% else %}
                      <tr><td colspan="6" class="text-center text-muted py-4">No users found.</td></tr>
                    {% endif %}

                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="text-center mb-4">
            <a href="/dashboard" class="btn btn-outline-secondary">Back to Dashboard</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create User Modal -->
  <div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="createUserForm">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">First Name</label>
              <input type="text" class="form-control" name="first_name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Last Name</label>
              <input type="text" class="form-control" name="last_name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Username</label>
              <input type="text" class="form-control" name="username" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" name="email" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" name="password" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Phone Number (optional)</label>
              <input type="tel" class="form-control" name="phone_number" placeholder="+1234567890">
            </div>
            <div class="mb-3">
              <label class="form-label">Role</label>
              <select class="form-select" name="role" required>
                <option value="teacher">Teacher</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Company (optional)</label>
              <input type="text" class="form-control" name="company">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="submitCreateUser">Create User</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://kit.fontawesome.com/a2e0d3a52c.js" crossorigin="anonymous"></script>

  <!-- User Create + Action Script -->
  <script>
    // Get CSRF token
    function getCsrfToken() {
      const cookieValue = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
      if (cookieValue) return cookieValue.split('=')[1];
      const input = document.querySelector('[name=csrfmiddlewaretoken]');
      if (input) return input.value;
      return null;
    }

    // Create User
    document.getElementById('submitCreateUser').addEventListener('click', async function() {
      const form = document.getElementById('createUserForm');
      const formData = new FormData(form);
      const btn = this;
      const originalText = btn.innerHTML;

      const userData = {
        first_name: formData.get('first_name'),
        last_name: formData.get('last_name'),
        username: formData.get('username'),
        email: formData.get('email'),
        password: formData.get('password'),
        phone_number: formData.get('phone_number') || '',
        role: formData.get('role'),
        company: formData.get('company') || ''
      };

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';

      try {
        const response = await fetch('/api/users/create/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          credentials: 'include',
          body: JSON.stringify(userData)
        });

        const result = await response.json();

        if (response.ok && result.success) {
          alert('✅ User created successfully!');
          location.reload();
        } else {
          alert('❌ Error: ' + (result.error || result.message || 'Failed to create user'));
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      } catch (error) {
        console.error('Error:', error);
        alert('❌ Network error: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    });

    // Activate/Deactivate User
    document.querySelectorAll('.userActionBtn').forEach(btn => {
      btn.addEventListener('click', async function() {
        const userId = this.dataset.userId;
        const action = this.dataset.action;
        const actionText = action === 'activate' ? 'activate' : 'deactivate';

        if (!confirm(`Are you sure you want to ${actionText} this user?`)) {
          return;
        }

        const originalHTML = this.innerHTML;
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        try {
          const response = await fetch('/api/users/delete/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCsrfToken()
            },
            credentials: 'include',
            body: JSON.stringify({
              user_id: parseInt(userId),
              action: action
            })
          });

          const result = await response.json();

          if (response.ok && result.success) {
            alert(`✅ User ${actionText}d successfully!`);
            location.reload();
          } else {
            alert('❌ Error: ' + (result.error || result.message || `Failed to ${actionText} user`));
            this.disabled = false;
            this.innerHTML = originalHTML;
          }
        } catch (error) {
          console.error('Error:', error);
          alert('❌ Network error: ' + error.message);
          this.disabled = false;
          this.innerHTML = originalHTML;
        }
      });
    });
  </script>

</body>
</html>

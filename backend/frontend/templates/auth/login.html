<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Login / Signup | SMS Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: linear-gradient(135deg, #1e3a8a, #3b82f6);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #333;
      font-family: "Inter", sans-serif;
    }

    .auth-container {
      position: relative;
      width: 900px;
      max-width: 100%;
      height: 520px;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      display: flex;
    }

    .form-container {
      position: absolute;
      top: 0;
      height: 100%;
      width: 50%;
      padding: 2rem;
      transition: all 0.6s ease-in-out;
    }

    .form-container h3 {
      font-weight: bold;
      color: #1e3a8a;
      margin-bottom: 1.5rem;
    }

    .form-control:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
    }

    .login-container { left: 0; z-index: 2; }
    .signup-container { left: 0; opacity: 0; z-index: 1; }

    .overlay-container {
      position: absolute;
      top: 0;
      left: 50%;
      width: 50%;
      height: 100%;
      background: linear-gradient(135deg, #1e3a8a, #3b82f6);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      transition: all 0.6s ease-in-out;
    }

    .overlay-container h4 { font-weight: bold; margin-bottom: 1rem; }
    .overlay-container button {
      background-color: white;
      color: #1e3a8a;
      border: none;
      padding: 10px 30px;
      border-radius: 20px;
      font-weight: 500;
      cursor: pointer;
      transition: 0.3s;
    }
    .overlay-container button:hover { background-color: #f1f5ff; }

    .auth-container.active .login-container { transform: translateX(100%); opacity: 0; z-index: 1; }
    .auth-container.active .signup-container { transform: translateX(100%); opacity: 1; z-index: 2; }
    .auth-container.active .overlay-container { transform: translateX(-100%); }

    @media (max-width: 768px) {
      .auth-container { flex-direction: column; height: auto; }
      .form-container, .overlay-container { position: relative; width: 100%; transform: none !important; }
    }

    .alert-fixed { position: fixed; top: 20px; right: 20px; z-index: 1050; min-width: 260px; }
  </style>
</head>
<body>
  <!-- API base constant (mounted in /api/) -->
  <script>const API_BASE = "/api";</script>

  <div class="auth-container" id="authContainer">
    <!-- Login Form -->
    <div class="form-container login-container">
      <h3>Welcome Back ðŸ‘‹</h3>

      <!-- Alert placeholder -->
      <div id="loginAlert"></div>

      <form id="loginForm" onsubmit="return handleLogin(event)">
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" id="loginEmail" placeholder="Enter email" required />
        </div>
        <div class="mb-3">
          <label class="form-label">Password</label>
          <input type="password" class="form-control" id="loginPassword" placeholder="Enter password" required />
        </div>

        <button class="btn btn-primary w-100" id="loginSubmit" type="submit">Login</button>

        <div class="text-center mt-3">
          <small><a href="#">Forgot Password?</a></small>
        </div>
      </form>
    </div>

    <!-- Signup Form -->
    <div class="form-container signup-container">
      <h3>Create Account âœ¨</h3>

      <!-- Alert placeholder -->
      <div id="signupAlert"></div>

      <form id="signupForm" onsubmit="return handleSignup(event)">
        <div class="mb-3">
          <label class="form-label">Full Name</label>
          <input type="text" id="signupName" class="form-control" placeholder="Enter full name" required />
        </div>
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" id="signupEmail" class="form-control" placeholder="Enter email" required />
        </div>
        <div class="mb-3">
          <label class="form-label">Password</label>
          <input type="password" id="signupPassword" class="form-control" placeholder="Enter password" required />
        </div>
        <div class="mb-3">
          <label class="form-label">Role</label>
          <select id="signupRole" class="form-select" required>
            <option value="">-- Select Role --</option>
            <option value="teacher">Teacher</option>
            <option value="admin">Admin</option>
          </select>
          <div class="form-text">Requesting 'admin' role may require manual approval server-side.</div>
        </div>
        <button class="btn btn-primary w-100" id="signupSubmit" type="submit">Sign Up</button>
      </form>
    </div>

    <!-- Overlay Panel -->
    <div class="overlay-container">
      <h4 id="overlayTitle">Hello, Friend!</h4>
      <p id="overlayText">Don't have an account? Sign up and start managing your SMS campaigns.</p>
      <button id="toggleButton" onclick="toggleForm()">Sign Up</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // UI helpers
    const container = document.getElementById("authContainer");
    const toggleButton = document.getElementById("toggleButton");
    const overlayTitle = document.getElementById("overlayTitle");
    const overlayText = document.getElementById("overlayText");

    function toggleForm() {
      container.classList.toggle("active");
      clearAlert('loginAlert');
      clearAlert('signupAlert');

      if (container.classList.contains("active")) {
        overlayTitle.textContent = "Welcome Back!";
        overlayText.textContent = "Already have an account? Log in to your dashboard.";
        toggleButton.textContent = "Login";
      } else {
        overlayTitle.textContent = "Hello, Friend!";
        overlayText.textContent = "Don't have an account? Sign up and start managing your SMS campaigns.";
        toggleButton.textContent = "Sign Up";
      }
    }

    function showAlert(containerId, message, type='danger', timeout=6000) {
      const container = document.getElementById(containerId);
      container.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
      if (timeout) setTimeout(() => { clearAlert(containerId); }, timeout);
    }
    function clearAlert(containerId) {
      const container = document.getElementById(containerId);
      if (container) container.innerHTML = '';
    }
    function setFormDisabled(formId, disabled=true) {
      const form = document.getElementById(formId);
      if (!form) return;
      Array.from(form.elements).forEach(el => el.disabled = disabled);
    }

    // -----------------------------
    // robust network helper
    // -----------------------------
    async function safeFetchJson(url, options = {}) {
      const resp = await fetch(url, options);
      const contentType = resp.headers.get('content-type') || '';
      const text = await resp.text();

      if (!resp.ok) {
        let message;
        if (contentType.includes('application/json')) {
          try {
            const json = JSON.parse(text);
            message = json.detail || json.message || JSON.stringify(json);
          } catch (e) {
            message = text.slice(0,1000);
          }
        } else {
          // likely an HTML error page (404)
          message = text.slice(0,1000);
        }
        const err = new Error(`HTTP ${resp.status}: ${message}`);
        err.status = resp.status;
        err.contentType = contentType;
        err.body = text;
        throw err;
      }

      if (contentType.includes('application/json')) {
        return JSON.parse(text);
      }
      return { _contentType: contentType, _text: text };
    }

    // -----------------------------
    // LOGIN / SIGNUP handlers
    // -----------------------------
    async function handleLogin(e) {
      e.preventDefault();
      clearAlert('loginAlert');

      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value.trim();
      if (!email || !password) {
        showAlert('loginAlert', 'Please fill in both email and password.', 'warning');
        return;
      }

      setFormDisabled('loginForm', true);
      document.getElementById('loginSubmit').textContent = 'Signing in...';

      try {
        const LOGIN_URL = `${API_BASE}/auth/login/`;
        const data = await safeFetchJson(LOGIN_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        if (data && data._contentType && data._contentType.includes('text/html')) {
          showAlert('loginAlert', 'Server returned HTML (404?). Check endpoint URL. Preview: ' + data._text.slice(0,300), 'danger', 10000);
          return;
        }

        if (data.tokens) {
          localStorage.setItem('accessToken', data.tokens.access);
          localStorage.setItem('refreshToken', data.tokens.refresh);
          
          // Also set cookies for backend authentication
          document.cookie = `accessToken=${data.tokens.access}; path=/; SameSite=Lax`;
          document.cookie = `refreshToken=${data.tokens.refresh}; path=/; SameSite=Lax`;
        }
        if (data.user) {
          localStorage.setItem('user', JSON.stringify(data.user));
          localStorage.setItem('role', data.user.role || 'teacher');
        }

        // redirect to dashboard page (frontend route, not API)
        window.location.href = '/dashboard/';
      } catch (err) {
        console.error('Login error', err);
        showAlert('loginAlert', err.message || 'Login failed', 'danger', 8000);
      } finally {
        setFormDisabled('loginForm', false);
        document.getElementById('loginSubmit').textContent = 'Login';
      }
    }

    async function handleSignup(e) {
      e.preventDefault();
      clearAlert('signupAlert');

      const name = document.getElementById("signupName").value.trim();
      const email = document.getElementById("signupEmail").value.trim();
      const password = document.getElementById("signupPassword").value.trim();
      const role = document.getElementById("signupRole").value;

      if (!name || !email || !password || !role) {
        showAlert('signupAlert', 'Please complete all fields.', 'warning');
        return;
      }

      setFormDisabled('signupForm', true);
      document.getElementById('signupSubmit').textContent = 'Creating...';

      try {
        const REGISTER_URL = `${API_BASE}/auth/register/`;
        const payload = {
          username: name.replace(/\s+/g, '').toLowerCase().slice(0, 30),
          email,
          password,
          password_confirm: password,
          phone_number: '',
          company: '',
          role
        };

        const data = await safeFetchJson(REGISTER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (data && data._contentType && data._contentType.includes('text/html')) {
          showAlert('signupAlert', 'Server returned HTML. Check endpoint URL. Preview: ' + data._text.slice(0,300), 'danger', 10000);
          return;
        }

        showAlert('signupAlert', 'Account created successfully. Redirecting...', 'success', 3000);

        if (data.tokens) {
          localStorage.setItem('accessToken', data.tokens.access);
          localStorage.setItem('refreshToken', data.tokens.refresh);
          
          // Also set cookies for backend authentication
          document.cookie = `accessToken=${data.tokens.access}; path=/; SameSite=Lax`;
          document.cookie = `refreshToken=${data.tokens.refresh}; path=/; SameSite=Lax`;
        }
        if (data.user) {
          localStorage.setItem('user', JSON.stringify(data.user));
          localStorage.setItem('role', data.user.role || role);
        }

        setTimeout(() => { window.location.href = '/dashboard/'; }, 900);
      } catch (err) {
        console.error('Signup error', err);
        showAlert('signupAlert', err.message || 'Signup failed', 'danger', 10000);
      } finally {
        setFormDisabled('signupForm', false);
        document.getElementById('signupSubmit').textContent = 'Sign Up';
      }
    }

    // Expose some helpers for debugging if needed
    window._authHelpers = {
      safeFetchJson,
      API_BASE,
      handleLogin,
      handleSignup
    };
  </script>
</body>
</html>

{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SMS Portal — Settings</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; min-height: 100vh; }
    .sidebar a.active { background-color: #3b82f6 !important; }
    .header { background-color: white; padding: 15px 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  </style>
</head>
<body>
  <!-- Set API_BASE before loading common.js -->
  <script>
    window.API_BASE = '{{ API_BASE }}';
  </script>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-2 p-0" id="sidebarContainer">
        <noscript>
          {% include 'includes/sidebar.html' with role=user_role %}
        </noscript>
        <div id="sidebarLoader" style="height:100vh;background:#1e3a8a;color:white;display:flex;align-items:center;justify-content:center;">
          <div>Loading navigation...</div>
        </div>
      </div>

      <!-- Main content -->
      <div class="col-md-10">
        <div class="header d-flex justify-content-between align-items-center">
          <div>
            <h4 class="mb-0">Settings</h4>
            <div style="font-size: .85rem; color: #6b7280;">Configure your SMS portal settings</div>
          </div>
          <div class="text-end">
            <div style="font-size: .85rem; color: #6b7280;">Signed in as</div>
            <div><strong>{{ user.email }}</strong></div>
          </div>
        </div>

        <div class="container mt-4">
          <!-- Settings Navigation -->
          <div class="row">
            <div class="col-md-3">
              <div class="card">
                <div class="card-header bg-white">
                  <h6 class="mb-0">Settings Categories</h6>
                </div>
                <div class="list-group list-group-flush">
                  <a href="#general" class="list-group-item list-group-item-action active" onclick="showTab('general', this)">
                    <i class="fas fa-cog me-2"></i>General Settings
                  </a>
                  <a href="#sms" class="list-group-item list-group-item-action" onclick="showTab('sms', this)">
                    <i class="fas fa-sms me-2"></i>SMS Configuration
                  </a>
                  <a href="#notifications" class="list-group-item list-group-item-action" onclick="showTab('notifications', this)">
                    <i class="fas fa-bell me-2"></i>Notifications
                  </a>
                  <a href="#security" class="list-group-item list-group-item-action" onclick="showTab('security', this)">
                    <i class="fas fa-shield-alt me-2"></i>Security
                  </a>
                  <a href="#api" class="list-group-item list-group-item-action" onclick="showTab('api', this)">
                    <i class="fas fa-code me-2"></i>API Settings
                  </a>
                  <a href="#backup" class="list-group-item list-group-item-action" onclick="showTab('backup', this)">
                    <i class="fas fa-database me-2"></i>Backup & Data
                  </a>
                </div>
              </div>
            </div>

            <div class="col-md-9">
              <!-- General Settings Tab -->
              <div class="settings-tab" id="general-tab">
                <div class="card">
                  <div class="card-header bg-white">
                    <h5 class="mb-0">General Settings</h5>
                  </div>
                  <div class="card-body">
                    <form id="generalSettingsForm">
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label class="form-label">Organization Name</label>
                          <input type="text" class="form-control" id="orgName" value="DBIT School">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Contact Email</label>
                          <input type="email" class="form-control" id="contactEmail" value="admin@dbitschool.edu">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Phone Number</label>
                          <input type="tel" class="form-control" id="phoneNumber" value="+91-9876543210">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Time Zone</label>
                          <select class="form-select" id="timezone">
                            <option value="Asia/Kolkata" selected>India Standard Time (IST)</option>
                            <option value="America/New_York">Eastern Time (EST)</option>
                            <option value="Europe/London">Greenwich Mean Time (GMT)</option>
                          </select>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Language</label>
                          <select class="form-select" id="language">
                            <option value="en" selected>English</option>
                            <option value="hi">Hindi</option>
                            <option value="mr">Marathi</option>
                          </select>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Date Format</label>
                          <select class="form-select" id="dateFormat">
                            <option value="DD/MM/YYYY" selected>DD/MM/YYYY</option>
                            <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                            <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                          </select>
                        </div>
                        <div class="col-12">
                          <label class="form-label">Organization Address</label>
                          <textarea class="form-control" id="orgAddress" rows="3">123 Education Street, Mumbai, Maharashtra, India - 400001</textarea>
                        </div>
                      </div>
                      <div class="mt-3">
                        <button type="submit" class="btn btn-primary">Save General Settings</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- SMS Configuration Tab -->
              <div class="settings-tab" id="sms-tab" style="display: none;">
                <div class="card">
                  <div class="card-header bg-white">
                    <h5 class="mb-0">SMS Configuration</h5>
                  </div>
                  <div class="card-body">
                    <form id="smsSettingsForm">
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label class="form-label">SMS Provider</label>
                          <select class="form-select" id="smsProvider">
                            <option value="twilio" selected>Twilio</option>
                            <option value="aws-sns">AWS SNS</option>
                            <option value="textlocal">TextLocal</option>
                            <option value="msg91">MSG91</option>
                          </select>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Default Sender ID</label>
                          <input type="text" class="form-control" id="defaultSender" value="DBITSCH">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">API Key</label>
                          <input type="password" class="form-control" id="apiKey" value="••••••••••••••••">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">API Secret</label>
                          <input type="password" class="form-control" id="apiSecret" value="••••••••••••••••">
                        </div>
                        <div class="col-md-4">
                          <label class="form-label">Daily SMS Limit</label>
                          <input type="number" class="form-control" id="dailyLimit" value="10000">
                        </div>
                        <div class="col-md-4">
                          <label class="form-label">Rate Limit (SMS/min)</label>
                          <input type="number" class="form-control" id="rateLimit" value="100">
                        </div>
                        <div class="col-md-4">
                          <label class="form-label">SMS Cost (per SMS)</label>
                          <input type="number" class="form-control" id="smsCost" value="0.15" step="0.01">
                        </div>
                        <div class="col-12">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableDeliveryReports" checked>
                            <label class="form-check-label" for="enableDeliveryReports">
                              Enable Delivery Reports
                            </label>
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableScheduling" checked>
                            <label class="form-check-label" for="enableScheduling">
                              Enable SMS Scheduling
                            </label>
                          </div>
                        </div>
                      </div>
                      <div class="mt-3">
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="testSMSConnection()">Test Connection</button>
                        <button type="submit" class="btn btn-primary">Save SMS Settings</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- Notifications Tab -->
              <div class="settings-tab" id="notifications-tab" style="display: none;">
                <div class="card">
                  <div class="card-header bg-white">
                    <h5 class="mb-0">Notification Preferences</h5>
                  </div>
                  <div class="card-body">
                    <form id="notificationSettingsForm">
                      <h6>Email Notifications</h6>
                      <div class="row g-3 mb-4">
                        <div class="col-12">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="emailSMSSuccess" checked>
                            <label class="form-check-label" for="emailSMSSuccess">
                              SMS Delivery Success Notifications
                            </label>
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="emailSMSFailure" checked>
                            <label class="form-check-label" for="emailSMSFailure">
                              SMS Delivery Failure Notifications
                            </label>
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="emailQuotaWarning" checked>
                            <label class="form-check-label" for="emailQuotaWarning">
                              SMS Quota Warning (90% reached)
                            </label>
                          </div>
                        </div>
                      </div>

                      <h6>System Notifications</h6>
                      <div class="row g-3 mb-4">
                        <div class="col-12">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="systemMaintenance" checked>
                            <label class="form-check-label" for="systemMaintenance">
                              System Maintenance Alerts
                            </label>
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="securityAlerts" checked>
                            <label class="form-check-label" for="securityAlerts">
                              Security & Login Alerts
                            </label>
                          </div>
                        </div>
                      </div>

                      <h6>Report Notifications</h6>
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label class="form-label">Daily Report Time</label>
                          <input type="time" class="form-control" id="dailyReportTime" value="18:00">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Weekly Report Day</label>
                          <select class="form-select" id="weeklyReportDay">
                            <option value="monday" selected>Monday</option>
                            <option value="friday">Friday</option>
                            <option value="sunday">Sunday</option>
                          </select>
                        </div>
                      </div>
                      <div class="mt-3">
                        <button type="submit" class="btn btn-primary">Save Notification Settings</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- Security Tab -->
              <div class="settings-tab" id="security-tab" style="display: none;">
                <div class="card">
                  <div class="card-header bg-white">
                    <h5 class="mb-0">Security Settings</h5>
                  </div>
                  <div class="card-body">
                    <form id="securitySettingsForm">
                      <h6>Password Policy</h6>
                      <div class="row g-3 mb-4">
                        <div class="col-md-6">
                          <label class="form-label">Minimum Password Length</label>
                          <input type="number" class="form-control" id="minPasswordLength" value="8" min="6" max="20">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Password Expiry (days)</label>
                          <input type="number" class="form-control" id="passwordExpiry" value="90">
                        </div>
                        <div class="col-12">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="requireSpecialChars" checked>
                            <label class="form-check-label" for="requireSpecialChars">
                              Require Special Characters
                            </label>
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="requireNumbers" checked>
                            <label class="form-check-label" for="requireNumbers">
                              Require Numbers
                            </label>
                          </div>
                        </div>
                      </div>

                      <h6>Session Management</h6>
                      <div class="row g-3 mb-4">
                        <div class="col-md-6">
                          <label class="form-label">Session Timeout (minutes)</label>
                          <input type="number" class="form-control" id="sessionTimeout" value="30">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Max Login Attempts</label>
                          <input type="number" class="form-control" id="maxLoginAttempts" value="3">
                        </div>
                      </div>

                      <h6>Two-Factor Authentication</h6>
                      <div class="row g-3">
                        <div class="col-12">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enable2FA">
                            <label class="form-check-label" for="enable2FA">
                              Enable Two-Factor Authentication
                            </label>
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="force2FA">
                            <label class="form-check-label" for="force2FA">
                              Force 2FA for All Admins
                            </label>
                          </div>
                        </div>
                      </div>
                      <div class="mt-3">
                        <button type="submit" class="btn btn-primary">Save Security Settings</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- API Settings Tab -->
              <div class="settings-tab" id="api-tab" style="display: none;">
                <div class="card">
                  <div class="card-header bg-white">
                    <h5 class="mb-0">API Settings</h5>
                  </div>
                  <div class="card-body">
                    <form id="apiSettingsForm">
                      <h6>API Configuration</h6>
                      <div class="row g-3 mb-4">
                        <div class="col-12">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableAPI" checked>
                            <label class="form-check-label" for="enableAPI">
                              Enable REST API
                            </label>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">API Rate Limit (requests/hour)</label>
                          <input type="number" class="form-control" id="apiRateLimit" value="1000">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">API Version</label>
                          <select class="form-select" id="apiVersion">
                            <option value="v1" selected>Version 1.0</option>
                            <option value="v2">Version 2.0 (Beta)</option>
                          </select>
                        </div>
                      </div>

                      <h6>API Keys</h6>
                      <div class="table-responsive mb-4">
                        <table class="table">
                          <thead>
                            <tr>
                              <th>Key Name</th>
                              <th>Created</th>
                              <th>Last Used</th>
                              <th>Status</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td>Main Application Key</td>
                              <td>2025-01-01</td>
                              <td>2025-01-15 14:30</td>
                              <td><span class="badge bg-success">Active</span></td>
                              <td>
                                <button class="btn btn-sm btn-outline-warning">Regenerate</button>
                                <button class="btn btn-sm btn-outline-danger">Revoke</button>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>

                      <div class="mt-3">
                        <button type="button" class="btn btn-outline-success me-2" onclick="generateAPIKey()">Generate New API Key</button>
                        <button type="submit" class="btn btn-primary">Save API Settings</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- Backup & Data Tab -->
              <div class="settings-tab" id="backup-tab" style="display: none;">
                <div class="card">
                  <div class="card-header bg-white">
                    <h5 class="mb-0">Backup & Data Management</h5>
                  </div>
                  <div class="card-body">
                    <form id="backupSettingsForm">
                      <h6>Automatic Backups</h6>
                      <div class="row g-3 mb-4">
                        <div class="col-12">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableAutoBackup" checked>
                            <label class="form-check-label" for="enableAutoBackup">
                              Enable Automatic Backups
                            </label>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Backup Frequency</label>
                          <select class="form-select" id="backupFrequency">
                            <option value="daily" selected>Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                          </select>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Backup Time</label>
                          <input type="time" class="form-control" id="backupTime" value="02:00">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Retention Period (days)</label>
                          <input type="number" class="form-control" id="retentionDays" value="30">
                        </div>
                      </div>

                      <h6>Manual Backup</h6>
                      <div class="row g-3 mb-4">
                        <div class="col-12">
                          <p class="text-muted">Create an immediate backup of your data</p>
                          <button type="button" class="btn btn-outline-primary me-2" onclick="createBackup()">Create Backup Now</button>
                          <button type="button" class="btn btn-outline-secondary" onclick="downloadBackup()">Download Latest Backup</button>
                        </div>
                      </div>

                      <h6>Data Export</h6>
                      <div class="row g-3">
                        <div class="col-12">
                          <p class="text-muted">Export your data in various formats</p>
                          <button type="button" class="btn btn-outline-info me-2" onclick="exportData('csv')">Export as CSV</button>
                          <button type="button" class="btn btn-outline-info me-2" onclick="exportData('json')">Export as JSON</button>
                          <button type="button" class="btn btn-outline-info" onclick="exportData('pdf')">Export as PDF Report</button>
                        </div>
                      </div>

                      <div class="mt-3">
                        <button type="submit" class="btn btn-primary">Save Backup Settings</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="{% static 'js/common/common.js' %}"></script>
  
  <script>
    // Tab switching functionality
    function showTab(tabName, element) {
      // Hide all tabs
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.style.display = 'none';
      });
      
      // Remove active class from all nav items
      document.querySelectorAll('.list-group-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName + '-tab').style.display = 'block';
      
      // Add active class to selected nav item
      element.classList.add('active');
    }

    // Form submission handlers
    document.getElementById('generalSettingsForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = {
        organization_name: document.getElementById('orgName').value,
        contact_email: document.getElementById('contactEmail').value,
        phone_number: document.getElementById('phoneNumber').value,
        timezone: document.getElementById('timezone').value,
        language: document.getElementById('language').value,
        date_format: document.getElementById('dateFormat').value,
        address: document.getElementById('orgAddress').value
      };

      try {
        const response = await window.AppAuth.authFetch(`${window.AppAuth.API_BASE}/settings/general/`, {
          method: 'POST',
          body: JSON.stringify(formData)
        });

        if (response.ok) {
          alert('General settings saved successfully!');
        } else {
          alert('Error saving settings');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('General settings saved successfully! (Demo mode)');
      }
    });

    document.getElementById('smsSettingsForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = {
        provider: document.getElementById('smsProvider').value,
        sender_id: document.getElementById('defaultSender').value,
        api_key: document.getElementById('apiKey').value,
        api_secret: document.getElementById('apiSecret').value,
        daily_limit: document.getElementById('dailyLimit').value,
        rate_limit: document.getElementById('rateLimit').value,
        sms_cost: document.getElementById('smsCost').value,
        delivery_reports: document.getElementById('enableDeliveryReports').checked,
        scheduling: document.getElementById('enableScheduling').checked
      };

      try {
        const response = await window.AppAuth.authFetch(`${window.AppAuth.API_BASE}/settings/sms/`, {
          method: 'POST',
          body: JSON.stringify(formData)
        });

        if (response.ok) {
          alert('SMS settings saved successfully!');
        } else {
          alert('Error saving SMS settings');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('SMS settings saved successfully! (Demo mode)');
      }
    });

    document.getElementById('notificationSettingsForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      alert('Notification settings saved successfully! (Demo mode)');
    });

    document.getElementById('securitySettingsForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      alert('Security settings saved successfully! (Demo mode)');
    });

    document.getElementById('apiSettingsForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      alert('API settings saved successfully! (Demo mode)');
    });

    document.getElementById('backupSettingsForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      alert('Backup settings saved successfully! (Demo mode)');
    });

    // Utility functions
    async function testSMSConnection() {
      try {
        const response = await window.AppAuth.authFetch(`${window.AppAuth.API_BASE}/settings/sms/test/`, {
          method: 'POST'
        });

        if (response.ok) {
          const result = await response.json();
          alert('SMS connection test successful!');
        } else {
          alert('SMS connection test failed');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('SMS connection test successful! (Demo mode)');
      }
    }

    function generateAPIKey() {
      const keyName = prompt('Enter API key name:');
      if (keyName) {
        alert(`New API key "${keyName}" generated successfully! (Demo mode)`);
        // In a real app, this would add a row to the API keys table
      }
    }

    function createBackup() {
      alert('Creating backup... This may take a few minutes. (Demo mode)');
      // Simulate backup creation
      setTimeout(() => {
        alert('Backup created successfully!');
      }, 2000);
    }

    function downloadBackup() {
      alert('Downloading latest backup... (Demo mode)');
      // In a real app, this would trigger a download
    }

    function exportData(format) {
      alert(`Exporting data as ${format.toUpperCase()}... (Demo mode)`);
      // In a real app, this would trigger data export
    }

    // Load current settings on page load
    async function loadSettings() {
      try {
        const response = await window.AppAuth.authFetch(`${window.AppAuth.API_BASE}/settings/`);
        if (response.ok) {
          const settings = await response.json();
          // Populate form fields with current settings
          // This would be implemented based on the actual API response structure
        }
      } catch (error) {
        console.error('Error loading settings:', error);
        // Settings are already populated with demo values in the HTML
      }
    }

    // Initialize settings page
    document.addEventListener('DOMContentLoaded', function() {
      loadSettings();
    });
  </script>
</body>
</html>
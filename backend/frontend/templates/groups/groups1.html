{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SMS Portal â€” Groups</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; min-height: 100vh; }
    .sidebar a.active { background-color: #3b82f6 !important; }
    .header { background-color: white; padding: 15px 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .contact-chip { display: inline-block; background: #e5e7eb; padding: 0.25rem 0.5rem; margin: 0.125rem; border-radius: 12px; font-size: 0.75rem; }
    .contact-chip .remove { color: #dc2626; cursor: pointer; margin-left: 0.25rem; }
  </style>
</head>
<body>
  <script>window.API_BASE = '{{ API_BASE }}';</script>

  <div class="container-fluid">
    <div class="row">
      <div class="col-md-2 p-0" id="sidebarContainer">
        <noscript>{% include 'includes/sidebar.html' with role=user_role %}</noscript>
        <div id="sidebarLoader" style="height:100vh;background:#1e3a8a;color:white;display:flex;align-items:center;justify-content:center;">
          <div>Loading navigation...</div>
        </div>
      </div>

      <div class="col-md-10">
        <div class="header d-flex justify-content-between align-items-center">
          <div>
            <h4 class="mb-0">Contact Groups</h4>
            <div style="font-size: .85rem; color: #6b7280;">Organize contacts into groups for bulk messaging</div>
          </div>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#groupModal" onclick="openGroupModal()">
            <i class="fas fa-plus"></i> Create New Group
          </button>
        </div>

        <div class="container mt-4">
          <!-- Stats Cards -->
          <div class="row g-3 mb-4">
            <div class="col-md-3">
              <div class="card text-center p-3">
                <h6>Total Groups</h6>
                <h3 class="text-primary" id="totalGroups">0</h3>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center p-3">
                <h6>Total Contacts</h6>
                <h3 class="text-success" id="totalContacts">0</h3>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center p-3">
                <h6>Active Groups</h6>
                <h3 class="text-info" id="activeGroups">0</h3>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center p-3">
                <h6>Avg Group Size</h6>
                <h3 class="text-warning" id="avgGroupSize">0</h3>
              </div>
            </div>
          </div>

          <!-- Groups Grid -->
          <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Groups</h5>
              <div class="d-flex gap-2">
                <input type="text" class="form-control form-control-sm" placeholder="Search groups..." id="searchGroups" style="width: 250px;">
                <select class="form-select form-select-sm" id="categoryFilter" style="width: 150px;">
                  <option value="">All Categories</option>
                  <option value="students">Students</option>
                  <option value="teachers">Teachers</option>
                  <option value="parents">Parents</option>
                  <option value="staff">Staff</option>
                </select>
              </div>
            </div>
            <div class="card-body">
              <div class="row" id="groupsGrid">
                <!-- Groups will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Group Modal -->
  <div class="modal fade" id="groupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="groupForm" onsubmit="return handleGroupSave(event)">
          <div class="modal-header">
            <h5 class="modal-title" id="groupModalTitle">Create New Group</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="groupId">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Group Name</label>
                  <input type="text" class="form-control" id="groupName" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Category</label>
                  <select class="form-select" id="groupCategory" required>
                    <option value="">Select Category</option>
                    <option value="students">Students</option>
                    <option value="teachers">Teachers</option>
                    <option value="parents">Parents</option>
                    <option value="staff">Staff</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Group Type</label>
              <select id="groupType" class="form-select" required>
                <option value="">-- Select Type --</option>
                <option value="student">Student</option>
                <option value="teacher">Teacher</option>
                <option value="parent">Parent</option>
                <option value="staff">Staff</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea id="groupDescription" class="form-control" rows="3"></textarea>
            </div>

            <hr>
            <h6>Add Members</h6>
            <div class="d-flex gap-2 mb-3">
              <input type="text" id="memberName" class="form-control" placeholder="Name">
              <input type="text" id="memberNumber" class="form-control" placeholder="Mobile Number">
              <button type="button" class="btn btn-outline-primary" id="addMemberBtn">Add</button>
            </div>

            <!-- Excel Import -->
            <div class="mb-3">
              <label class="form-label fw-bold">Upload Excel or CSV</label>
              <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" class="form-control">
              <div class="form-text">Expected columns: <b>Name</b> and <b>Number</b></div>
            </div>

            <div id="membersList" class="mt-3"></div>            <!-- Add Contacts Section -->
            <div class="mb-3">
              <label class="form-label">Add Contacts</label>
              <div class="input-group mb-2">
                <input type="text" class="form-control" id="newContact" placeholder="Enter phone number or email">
                <button type="button" class="btn btn-outline-secondary" onclick="addContact()">Add</button>
              </div>
              <small class="text-muted">Or paste multiple contacts (one per line)</small>
              <textarea class="form-control mt-2" id="bulkContacts" rows="3" placeholder="Enter multiple contacts (one per line)&#10;+1234567890&#10;john@example.com&#10;+9876543210"></textarea>
              <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addBulkContacts()">Add Bulk Contacts</button>
            </div>

            <!-- Contacts List -->
            <div class="mb-3">
              <label class="form-label">Contacts (<span id="contactCount">0</span>)</label>
              <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;" id="contactsList">
                <!-- Contacts will appear here -->
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Group</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Group Details Modal -->
  <div class="modal fade" id="groupDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="groupDetailsTitle">Group Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="groupDetailsBody">
          <!-- Group details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="sendSMSToGroup()">Send SMS to Group</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{% static 'js/common/common.js' %}"></script>
  
  <script>
    let groups = [];
    let editingGroupId = null;
    let currentGroupContacts = [];

    // Load groups from API
    async function loadGroups() {
      try {
        const response = await window.AppAuth.authFetch(`${window.AppAuth.API_BASE}/groups/`);
        if (response.ok) {
          groups = await response.json();
        }
      } catch (error) {
        console.error('Error loading groups:', error);
        // Mock data for demo
        groups = [
          { id: 1, name: 'Class 10A Students', category: 'students', description: 'All students from Class 10A', contacts: ['+1234567890', '+1234567891', '+1234567892'], is_active: true, created_at: '2025-10-15' },
          { id: 2, name: 'Math Teachers', category: 'teachers', description: 'Mathematics department teachers', contacts: ['math1@school.com', 'math2@school.com'], is_active: true, created_at: '2025-10-10' },
          { id: 3, name: 'Parent Committee', category: 'parents', description: 'Parent-teacher committee members', contacts: ['+1111111111', '+2222222222', '+3333333333', '+4444444444'], is_active: true, created_at: '2025-10-08' },
          { id: 4, name: 'Administrative Staff', category: 'staff', description: 'Admin and support staff', contacts: ['admin@school.com', 'support@school.com'], is_active: true, created_at: '2025-10-05' }
        ];
      }
      renderGroups();
      updateStats();
    }

    function renderGroups(filteredGroups = groups) {
      const grid = document.getElementById('groupsGrid');
      grid.innerHTML = '';
      
      filteredGroups.forEach(group => {
        const categoryColors = {
          'students': 'primary',
          'teachers': 'success', 
          'parents': 'warning',
          'staff': 'info'
        };
        const categoryColor = categoryColors[group.category] || 'secondary';
        
        grid.innerHTML += `
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="card-title mb-0">${group.name}</h6>
                  <span class="badge bg-${categoryColor} ms-2">${group.category}</span>
                </div>
                <p class="card-text text-muted small">${group.description}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <small class="text-muted">${group.contacts.length} contacts</small>
                  <small class="text-muted">${new Date(group.created_at).toLocaleDateString()}</small>
                </div>
              </div>
              <div class="card-footer bg-white border-0 pt-0">
                <div class="btn-group w-100" role="group">
                  <button class="btn btn-sm btn-outline-primary" onclick="viewGroup(${group.id})">View</button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="editGroup(${group.id})">Edit</button>
                  <button class="btn btn-sm btn-outline-success" onclick="sendToGroup(${group.id})">Send SMS</button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteGroup(${group.id})">Delete</button>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      if (filteredGroups.length === 0) {
        grid.innerHTML = '<div class="col-12"><div class="text-center py-4"><p class="text-muted">No groups found</p></div></div>';
      }
    }

    function updateStats() {
      const totalContacts = groups.reduce((sum, group) => sum + group.contacts.length, 0);
      const avgSize = groups.length > 0 ? Math.round(totalContacts / groups.length) : 0;
      
      document.getElementById('totalGroups').textContent = groups.length;
      document.getElementById('totalContacts').textContent = totalContacts;
      document.getElementById('activeGroups').textContent = groups.filter(g => g.is_active).length;
      document.getElementById('avgGroupSize').textContent = avgSize;
    }

    function openGroupModal(groupId = null) {
      editingGroupId = groupId;
      currentGroupContacts = [];
      
      const form = document.getElementById('groupForm');
      const title = document.getElementById('groupModalTitle');
      
      form.reset();
      updateContactsList();
      
      if (groupId) {
        const group = groups.find(g => g.id === groupId);
        title.textContent = 'Edit Group';
        document.getElementById('groupId').value = group.id;
        document.getElementById('groupName').value = group.name;
        document.getElementById('groupCategory').value = group.category;
        document.getElementById('groupDescription').value = group.description;
        currentGroupContacts = [...group.contacts];
        updateContactsList();
      } else {
        title.textContent = 'Create New Group';
      }
    }

    function addContact() {
      const input = document.getElementById('newContact');
      const contact = input.value.trim();
      
      if (!contact) return;
      
      if (currentGroupContacts.includes(contact)) {
        alert('Contact already added');
        return;
      }
      
      currentGroupContacts.push(contact);
      input.value = '';
      updateContactsList();
    }

    function addBulkContacts() {
      const textarea = document.getElementById('bulkContacts');
      const contacts = textarea.value.split('\n').map(c => c.trim()).filter(c => c);
      
      contacts.forEach(contact => {
        if (!currentGroupContacts.includes(contact)) {
          currentGroupContacts.push(contact);
        }
      });
      
      textarea.value = '';
      updateContactsList();
    }

    function removeContact(index) {
      currentGroupContacts.splice(index, 1);
      updateContactsList();
    }

    function updateContactsList() {
      const container = document.getElementById('contactsList');
      const countSpan = document.getElementById('contactCount');
      
      countSpan.textContent = currentGroupContacts.length;
      
      if (currentGroupContacts.length === 0) {
        container.innerHTML = '<p class="text-muted m-0">No contacts added yet</p>';
        return;
      }
      
      container.innerHTML = currentGroupContacts.map((contact, index) => 
        `<span class="contact-chip">${contact} <span class="remove" onclick="removeContact(${index})">&times;</span></span>`
      ).join('');
    }

    async function handleGroupSave(event) {
      event.preventDefault();
      
      if (currentGroupContacts.length === 0) {
        alert('Please add at least one contact');
        return;
      }
      
      const formData = {
        name: document.getElementById('groupName').value,
        category: document.getElementById('groupCategory').value,
        description: document.getElementById('groupDescription').value,
        contacts: currentGroupContacts
      };

      try {
        let response;
        if (editingGroupId) {
          // Update existing group
          response = await window.AppAuth.authFetch(`${window.AppAuth.API_BASE}/groups/${editingGroupId}/`, {
            method: 'PATCH',
            body: JSON.stringify(formData)
          });
        } else {
          // Create new group
          response = await window.AppAuth.authFetch(`${window.AppAuth.API_BASE}/groups/`, {
            method: 'POST',
            body: JSON.stringify(formData)
          });
        }

        if (response.ok) {
          alert(editingGroupId ? 'Group updated successfully!' : 'Group created successfully!');
          bootstrap.Modal.getInstance(document.getElementById('groupModal')).hide();
          loadGroups();
        } else {
          const error = await response.json();
          alert('Error: ' + (error.message || 'Failed to save group'));
        }
      } catch (error) {
        console.error('Error saving group:', error);
        
        // Demo: simulate success
        bootstrap.Modal.getInstance(document.getElementById('groupModal')).hide();
        if (editingGroupId) {
          const groupIndex = groups.findIndex(g => g.id === editingGroupId);
          groups[groupIndex] = { ...groups[groupIndex], ...formData };
        } else {
          const newGroup = {
            id: groups.length + 1,
            ...formData,
            is_active: true,
            created_at: new Date().toISOString().split('T')[0]
          };
          groups.push(newGroup);
        }
        renderGroups();
        updateStats();
        alert('Group saved successfully! (Demo mode)');
      }
    }

    function viewGroup(id) {
      const group = groups.find(g => g.id === id);
      document.getElementById('groupDetailsTitle').textContent = group.name;
      
      const body = document.getElementById('groupDetailsBody');
      body.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <h6>Group Information</h6>
            <p><strong>Name:</strong> ${group.name}</p>
            <p><strong>Category:</strong> ${group.category}</p>
            <p><strong>Description:</strong> ${group.description}</p>
            <p><strong>Created:</strong> ${new Date(group.created_at).toLocaleDateString()}</p>
          </div>
          <div class="col-md-6">
            <h6>Contacts (${group.contacts.length})</h6>
            <div style="max-height: 200px; overflow-y: auto;">
              ${group.contacts.map(contact => `<div class="py-1">${contact}</div>`).join('')}
            </div>
          </div>
        </div>
      `;
      
      new bootstrap.Modal(document.getElementById('groupDetailsModal')).show();
    }

    function editGroup(id) {
      openGroupModal(id);
      new bootstrap.Modal(document.getElementById('groupModal')).show();
    }

    function sendToGroup(id) {
      const group = groups.find(g => g.id === id);
      alert(`Redirecting to Send SMS page with group "${group.name}" selected...`);
      // In a real app, redirect to send SMS page with group pre-selected
      window.location.href = `/send/?group=${id}`;
    }

    async function deleteGroup(id) {
      const group = groups.find(g => g.id === id);
      if (!confirm(`Are you sure you want to delete group "${group.name}"?`)) return;

      try {
        const response = await window.AppAuth.authFetch(`${window.AppAuth.API_BASE}/groups/${id}/`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('Group deleted successfully!');
          loadGroups();
        } else {
          alert('Error deleting group');
        }
      } catch (error) {
        console.error('Error deleting group:', error);
        // Demo: simulate success
        groups = groups.filter(g => g.id !== id);
        renderGroups();
        updateStats();
        alert('Group deleted successfully! (Demo mode)');
      }
    }

    // Search and filter functionality
    document.getElementById('searchGroups').addEventListener('input', filterGroups);
    document.getElementById('categoryFilter').addEventListener('change', filterGroups);

    function filterGroups() {
      const search = document.getElementById('searchGroups').value.toLowerCase();
      const categoryFilter = document.getElementById('categoryFilter').value;
      
      let filtered = groups.filter(group => {
        const matchesSearch = !search || 
          group.name.toLowerCase().includes(search) ||
          group.description.toLowerCase().includes(search);
        
        const matchesCategory = !categoryFilter || group.category === categoryFilter;
        
        return matchesSearch && matchesCategory;
      });
      
      renderGroups(filtered);
    }

        // Initialize
    document.addEventListener('DOMContentLoaded', loadGroups);
  </script>
  
  <!-- Chart.js for analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Group Distribution Chart
    const ctx = document.getElementById('groupsChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Students', 'Teachers', 'Parents', 'Staff'],
        datasets: [{
          data: [12, 8, 15, 5],
          backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  </script>

  <!-- Global Sidebar Loader -->
  <script src="{% static 'js/components/sidebar.js' %}"></script>
  <script src="{% static 'js/common/common.js' %}"></script>
</body>
</html>


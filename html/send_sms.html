<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Send SMS | SMS Portal</title>

  <!-- Bootstrap & Flatpickr -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">

  <style>
    body { background-color: #f8f9fa; }
    .sidebar a.active { background-color: #3b82f6 !important; }
    .header { background-color: white; padding:15px 25px; box-shadow:0 2px 4px rgba(0,0,0,0.05); }
    .card { border:none; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
    .variable-input { display:inline-block; width:auto; min-width:120px; margin:5px 0; }
    table { font-size:0.9rem; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar dynamically loaded -->
      <div class="col-md-2 p-0" id="sidebarContainer"></div>

      <!-- Main content -->
      <div class="col-md-10">
        <div class="header d-flex justify-content-between align-items-center">
          <h4>Send SMS</h4>
          <div><strong>User:</strong> teacher1</div>
        </div>

        <div class="container mt-4">
          <div class="card p-4">
            <h5 class="mb-3">Compose Personalized SMS</h5>

            <form id="smsForm" onsubmit="return handleSubmit(event)">
              <!-- Sender ID -->
              <div class="mb-3">
                <label for="senderId" class="form-label">Sender ID</label>
                <select id="senderId" class="form-select">
                  <option value="COLLGE">COLLGE</option>
                  <option value="ADMIN">ADMIN</option>
                </select>
              </div>

              <!-- Template -->
              <div class="mb-3">
                <label for="template" class="form-label">Template</label>
                <select id="template" class="form-select" onchange="handleTemplateChange()">
                  <option value="">-- Select Template --</option>
                  <option value="attendance">Attendance Alert</option>
                  <option value="reminder">Event Reminder</option>
                  <option value="fee">Fee Reminder</option>
                  <option value="appreciation">Appreciation Note</option>
                  <option value="teacher_meeting">Teacher Meeting Notice</option>
                </select>
                <small id="templateTypeLabel" class="text-muted"></small>
              </div>

              <!-- Groups -->
              <div class="mb-3">
                <label for="groupSelect" class="form-label">Select Group</label>
                <select id="groupSelect" class="form-select" onchange="updateRecipients()">
                  <option value="">-- Select Group --</option>
                  <option value="Class 10A">Class 10A</option>
                  <option value="Teachers">Teachers</option>
                </select>
                <small id="groupTypeLabel" class="text-muted"></small>
              </div>

              <!-- Variable Inputs -->
              <div id="variables" class="mb-3"></div>

              <!-- Recipients -->
              <div class="mb-3">
                <label class="form-label">Recipients</label>
                <textarea id="recipients" class="form-control" rows="3" readonly></textarea>
              </div>

              <!-- Preview Table -->
              <div id="previewSection" class="mb-3" style="display:none;">
                <h6 class="mb-2">Personalized Message Preview</h6>
                <table class="table table-striped table-sm align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Name</th>
                      <th>Number</th>
                      <th>Message</th>
                    </tr>
                  </thead>
                  <tbody id="previewTableBody"></tbody>
                </table>
              </div>

              <button type="submit" class="btn btn-primary w-100">Send SMS</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Flatpickr -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- JS Logic -->
  <script>
    const groups = {
      "Class 10A": { type: "student", members: [
        { name: "Ayesha Khan", number: "9876543210" },
        { name: "Rohan Patel", number: "9123456789" },
        { name: "Sara Ahmed", number: "9988776655" }
      ]},
      "Teachers": { type: "teacher", members: [
        { name: "Mr. Sharma", number: "9988223344" },
        { name: "Ms. Iqbal", number: "9776655443" }
      ]}
    };

    const templates = {
      attendance: { text: "Dear parent, your child {student_name} was absent on {date}.", type: "student" },
      reminder: { text: "Dear {student_name}, you are invited to {event} on {date}.", type: "student" },
      fee: { text: "Dear {student_name}, please pay your fees for {month}.", type: "student" },
      appreciation: { text: "Dear {student_name}, congratulations on your excellent performance in {subject}!", type: "student" },
      teacher_meeting: { text: "Dear {teacher_name}, please attend the meeting on {date} regarding {event}.", type: "teacher" }
    };

    let selectedGroup = [];
    let selectedTemplate = "";
    let selectedTemplateType = "";
    let selectedGroupType = "";
    let selectedGroupName = "";

    function handleTemplateChange() {
      const templateKey = document.getElementById("template").value;
      const typeLabel = document.getElementById("templateTypeLabel");
      const groupSelect = document.getElementById("groupSelect");
      const groupLabel = document.getElementById("groupTypeLabel");

      document.getElementById("variables").innerHTML = "";
      document.getElementById("recipients").value = "";
      document.getElementById("previewTableBody").innerHTML = "";
      document.getElementById("previewSection").style.display = "none";

      if (!templateKey) {
        typeLabel.textContent = "";
        groupLabel.textContent = "";
        groupSelect.disabled = false;
        return;
      }

      const template = templates[templateKey];
      selectedTemplate = template.text;
      selectedTemplateType = template.type;
      typeLabel.textContent = `🧩 Template Type: ${selectedTemplateType.toUpperCase()} message`;

      groupSelect.value = "";
      groupLabel.textContent = "Please select a group that matches the template type.";

      Array.from(groupSelect.options).forEach(opt => {
        if (opt.value === "") return;
        const gType = groups[opt.value].type;
        opt.disabled = gType !== selectedTemplateType;
      });

      updateVariableInputs(template.text);
    }

    function updateVariableInputs(templateText) {
      const variablesDiv = document.getElementById("variables");
      variablesDiv.innerHTML = "";

      const matches = templateText.match(/{(.*?)}/g) || [];
      matches.forEach(match => {
        const varName = match.replace(/[{}]/g, "");
        if (varName === "student_name" || varName === "teacher_name") return;

        const label = document.createElement("label");
        label.className = "form-label";
        label.textContent = `Enter ${varName.replace(/_/g, ' ')}:`;

        const input = document.createElement("input");
        input.type = "text";
        input.className = "form-control variable-input";
        input.placeholder = varName;

        if (varName.toLowerCase().includes("date")) {
          flatpickr(input, { dateFormat: "d-m-Y", allowInput: true, onChange: updateMessage });
        } else {
          input.addEventListener("input", updateMessage);
        }

        variablesDiv.appendChild(label);
        variablesDiv.appendChild(input);
      });
    }

    function updateRecipients() {
      const groupName = document.getElementById("groupSelect").value;
      if (!groupName) return;

      const group = groups[groupName];
      selectedGroupType = group.type;

      if (selectedTemplateType && group.type !== selectedTemplateType) {
        alert("❌ This template is not allowed for the selected group!");
        document.getElementById("groupSelect").value = "";
        document.getElementById("recipients").value = "";
        selectedGroup = [];
        return;
      }

      selectedGroup = group.members;
      selectedGroupName = groupName;
      document.getElementById("groupTypeLabel").textContent = `👥 Group Type: ${group.type.toUpperCase()} group`;
      document.getElementById("recipients").value = group.members.map(m => `${m.name} (${m.number})`).join(", ");
      updateMessage();
    }

    function updateMessage() {
      if (!selectedTemplate || selectedGroup.length === 0) return;

      const baseText = selectedTemplate;
      const inputs = document.querySelectorAll(".variable-input");
      const tableBody = document.getElementById("previewTableBody");
      const previewSection = document.getElementById("previewSection");

      let replacements = {};
      inputs.forEach(input => replacements[input.placeholder] = input.value || `{${input.placeholder}}`);

      tableBody.innerHTML = "";

      selectedGroup.forEach(member => {
        let personalized = baseText;
        Object.entries(replacements).forEach(([k, v]) => {
          personalized = personalized.replaceAll(`{${k}}`, v);
        });

        if (selectedGroupType === "teacher")
          personalized = personalized.replaceAll("{teacher_name}", member.name);
        else
          personalized = personalized.replaceAll("{student_name}", member.name);

        tableBody.innerHTML += `<tr><td>${member.name}</td><td>${member.number}</td><td>${personalized}</td></tr>`;
      });

      previewSection.style.display = "block";
    }

    function handleSubmit(e) {
      e.preventDefault();
      if (!selectedTemplate || selectedGroup.length === 0) {
        alert("Please select both a template and a valid group.");
        return;
      }

      const inputs = document.querySelectorAll(".variable-input");
      let replacements = {};
      inputs.forEach(input => replacements[input.placeholder] = input.value || `{${input.placeholder}}`);

      const payload = selectedGroup.map(member => {
        let msg = selectedTemplate;
        Object.entries(replacements).forEach(([k, v]) => {
          msg = msg.replaceAll(`{${k}}`, v);
        });
        msg = msg.replaceAll("{student_name}", member.name);
        msg = msg.replaceAll("{teacher_name}", member.name);
        return { name: member.name, number: member.number, message: msg };
      });

      console.log("📦 Final SMS Payload:", payload);
      alert("✅ Personalized messages prepared. Check console for details.");
    }
  </script>

  <!-- Global Sidebar Loader -->
  <script src="./js/common.js"></script>
</body>
</html>
